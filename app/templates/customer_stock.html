{% extends "base.html" %} {% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2>Customer Stock Management</h2>
    {% if low_stock_count > 0 %}
    <div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle"></i>
      <strong>{{ low_stock_count }}</strong> item(s) are running low on stock
    </div>
    {% endif %}
  </div>
  <div>
    <button class="btn btn-success" onclick="showAddStockModal()">
      <i class="bi bi-plus-circle"></i> Add New Stock Item
    </button>
    <button class="btn btn-primary" onclick="showQuickTransactionModal()">
      <i class="bi bi-arrow-down-up"></i> Quick Transaction
    </button>
  </div>
</div>

<!-- Stock Overview Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="text-primary">{{ stock_items|length }}</h5>
        <small>Total Stock Items</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="text-warning">{{ low_stock_count }}</h5>
        <small>Low Stock Alerts</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="text-info">
          {{ stock_items|map(attribute='customer')|unique|list|length }}
        </h5>
        <small>Customers with Stock</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="text-success">
          {{ stock_items|sum(attribute='current_stock') }}
        </h5>
        <small>Total Units in Stock</small>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row">
      <div class="col-md-4">
        <label class="form-label">Filter by Customer</label>
        <select
          class="form-select"
          id="customerFilter"
          onchange="filterStock()"
        >
          <option value="">All Customers</option>
          {% for customer in
          stock_items|map(attribute='customer')|unique|sort(attribute='name') %}
          <option value="{{ customer.id }}">{{ customer.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Search Product</label>
        <input
          type="text"
          class="form-control"
          id="productSearch"
          placeholder="Search by product code or name"
          onkeyup="filterStock()"
        />
      </div>
      <div class="col-md-4">
        <label class="form-label">Stock Status</label>
        <select
          class="form-select"
          id="stockStatusFilter"
          onchange="filterStock()"
        >
          <option value="">All Stock</option>
          <option value="low">Low Stock Only</option>
          <option value="normal">Normal Stock</option>
          <option value="zero">Out of Stock</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Stock Items Table -->
<div class="card">
  <div class="card-header">
    <h5>Current Stock Items</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover" id="stockTable">
        <thead>
          <tr>
            <th>Customer</th>
            <th>Product Code</th>
            <th>Product Name</th>
            <th>Current Stock</th>
            <th>Reorder Level</th>
            <th>Status</th>
            <th>Last Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in stock_items %}
          <tr
            data-customer-id="{{ item.customer.id }}"
            data-product="{{ item.product_name.lower() }} {{ (item.product_code or '')|lower }}"
            data-stock-status="{% if item.current_stock == 0 %}zero{% elif item.current_stock <= item.reorder_level %}low{% else %}normal{% endif %}"
          >
            <td>{{ item.customer.name }}</td>
            <td>{{ item.product_code or 'N/A' }}</td>
            <td>{{ item.product_name }}</td>
            <td>{{ item.current_stock }}</td>
            <td>{{ item.reorder_level }}</td>
            <td>
              {% if item.current_stock == 0 %}
              <span class="badge bg-danger">Out of Stock</span>
              {% elif item.current_stock <= item.reorder_level %}
              <span class="badge bg-warning">Low Stock</span>
              {% else %}
              <span class="badge bg-success">In Stock</span>
              {% endif %}
            </td>
            <td>{{ item.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <button
                  class="btn btn-sm btn-success"
                  onclick="showStockInModal({{ item.id }}, '{{ item.customer.name }}', '{{ item.product_name }}')"
                  title="Add Stock"
                >
                  <i class="bi bi-plus-circle"></i>
                </button>

                <button
                  class="btn btn-sm btn-info"
                  onclick="showStockHistory({{ item.id }})"
                  title="View History"
                >
                  <i class="bi bi-clock-history"></i>
                </button>
                <button
                  class="btn btn-sm btn-secondary"
                  onclick="editStockItem({{ item.id }})"
                >
                  <i class="bi bi-pencil"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add New Stock Item Modal -->
<div class="modal fade" id="addStockModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Stock Item</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="addStockForm">
          <!-- Customer Search Section -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Customer Account Number *</label>
              <div class="search-container position-relative">
                <input
                  type="text"
                  class="form-control"
                  id="newStockCustomerAccount"
                  required
                  placeholder="Search by account number or name"
                />
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Customer Name *</label>
              <div class="search-container position-relative">
                <input
                  type="text"
                  class="form-control"
                  id="newStockCustomerName"
                  required
                  placeholder="Search by name or account"
                />
              </div>
            </div>
          </div>

          <!-- Selected Customer Info -->
          <div
            id="selectedCustomerInfo"
            class="alert alert-info mb-3"
            style="display: none"
          >
            <strong>Selected Customer:</strong><br />
            <span id="selectedCustomerDetails"></span>
          </div>

          <!-- Hidden field for customer ID -->
          <input type="hidden" id="newStockCustomerId" />

          <!-- ADDRESS SELECTION CONTAINER -->
          <div id="addStockAddressContainer" class="mb-3"></div>

          <!-- Product Details -->
          <div class="row">
            <div class="col-md-12 mb-3">
              <label class="form-label">Product Code</label>
              <input
                type="text"
                class="form-control"
                id="newStockProductCode"
                placeholder="Optional"
              />
              <small class="form-text text-muted"
                >Product code is optional</small
              >
            </div>
          </div>

          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">Product Name *</label>
              <input
                type="text"
                class="form-control"
                id="newStockProductName"
                required
              />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Reorder Level</label>
              <input
                type="number"
                class="form-control"
                id="newStockReorderLevel"
                min="0"
                value="5"
              />
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Initial Stock</label>
              <input
                type="number"
                class="form-control"
                id="newStockInitial"
                min="0"
                value="0"
              />
            </div>
            <div class="col-md-8 mb-3">
              <label class="form-label">Invoice Number</label>
              <input
                type="text"
                class="form-control"
                id="newStockInvoiceNumber"
                placeholder="Invoice number (if applicable)"
              />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea
              class="form-control"
              id="newStockNotes"
              rows="2"
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="saveNewStock()">
          Create Stock Item
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Stock In Modal -->
<div class="modal fade" id="stockInModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Stock In</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="stockInItemId" />
        <div class="alert alert-info">
          <strong>Customer:</strong> <span id="stockInCustomer"></span><br />
          <strong>Product:</strong> <span id="stockInProduct"></span>
        </div>
        <div class="mb-3">
          <label class="form-label">Quantity Received *</label>
          <input
            type="number"
            class="form-control"
            id="stockInQuantity"
            min="1"
            required
          />
        </div>
        <div class="mb-3">
          <label class="form-label">Invoice Number</label>
          <input
            type="text"
            class="form-control"
            id="stockInInvoiceNumber"
            placeholder="Invoice number"
          />
        </div>
        <div class="mb-3">
          <label class="form-label">Notes</label>
          <textarea class="form-control" id="stockInNotes" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-success"
          onclick="processStockIn()"
        >
          Add to Stock
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Stock History Modal -->
<div class="modal fade" id="stockHistoryModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Stock Transaction History</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div id="historyContent">
          <!-- History will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Transaction Modal -->
<div class="modal fade" id="quickTransactionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Quick Stock Transaction</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Search Stock Item</label>
          <input
            type="text"
            class="form-control"
            id="quickSearchStock"
            placeholder="Type customer name or product..."
          />
          <div id="quickSearchResults" class="mt-2"></div>
        </div>
        <div id="quickTransactionForm" style="display: none">
          <input type="hidden" id="quickStockId" />
          <div class="alert alert-info">
            <strong>Selected:</strong> <span id="quickSelectedItem"></span>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Transaction Type</label>
              <select class="form-select" id="quickTransactionType">
                <option value="stock_in">Stock In</option>
                <option value="adjustment">Adjustment</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Quantity</label>
              <input
                type="number"
                class="form-control"
                id="quickQuantity"
                required
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Invoice Number</label>
            <input type="text" class="form-control" id="quickInvoiceNumber" />
          </div>
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" id="quickNotes" rows="2"></textarea>
          </div>
          <button
            type="button"
            class="btn btn-primary"
            onclick="processQuickTransaction()"
          >
            Process Transaction
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}

<script>
  let addStockModal, stockInModal, stockHistoryModal, quickTransactionModal;
  let selectedCustomerId = null;
  let selectedCustomerName = null;
  let customerSearchTimeout = null;

  document.addEventListener("DOMContentLoaded", function () {
    addStockModal = new bootstrap.Modal(
      document.getElementById("addStockModal")
    );
    stockInModal = new bootstrap.Modal(document.getElementById("stockInModal"));
    stockHistoryModal = new bootstrap.Modal(
      document.getElementById("stockHistoryModal")
    );
    quickTransactionModal = new bootstrap.Modal(
      document.getElementById("quickTransactionModal")
    );

    setupCustomerSearchForStock();

    const quickSearch = document.getElementById("quickSearchStock");
    if (quickSearch) {
      quickSearch.addEventListener("input", searchStockItems);
    }
  });

  function showAddStockModal() {
    document.getElementById("addStockForm").reset();
    document.getElementById("newStockCustomerId").value = "";
    document.getElementById("selectedCustomerInfo").style.display = "none";
    document.getElementById("addStockAddressContainer").innerHTML = "";
    selectedCustomerId = null;
    selectedCustomerName = null;
    addStockModal.show();
  }

  function showQuickTransactionModal() {
    quickTransactionModal.show();
  }

  function searchStockItems() {
    const searchTerm = document
      .getElementById("quickSearchStock")
      .value.toLowerCase();
    const rows = document.querySelectorAll(".stock-table tbody tr");

    rows.forEach((row) => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? "" : "none";
    });
  }

  // ==================== CUSTOMER SEARCH FOR ADD STOCK ====================

  function setupCustomerSearchForStock() {
    const accountInput = document.getElementById("newStockCustomerAccount");
    const nameInput = document.getElementById("newStockCustomerName");

    if (accountInput) {
      accountInput.addEventListener("input", function () {
        clearTimeout(customerSearchTimeout);
        const searchValue = this.value.trim();

        if (searchValue.length < 2) {
          hideCustomerDropdown(accountInput);
          if (searchValue.length === 0) {
            clearSelectedCustomer();
          }
          return;
        }

        customerSearchTimeout = setTimeout(() => {
          searchCustomersForStock(searchValue, accountInput, "account");
        }, 300);
      });
    }

    if (nameInput) {
      nameInput.addEventListener("input", function () {
        clearTimeout(customerSearchTimeout);
        const searchValue = this.value.trim();

        if (searchValue.length < 2) {
          hideCustomerDropdown(nameInput);
          if (searchValue.length === 0) {
            clearSelectedCustomer();
          }
          return;
        }

        customerSearchTimeout = setTimeout(() => {
          searchCustomersForStock(searchValue, nameInput, "name");
        }, 300);
      });
    }
  }

  async function searchCustomersForStock(searchValue, inputElement, fieldType) {
    try {
      const response = await fetch(
        `/customers/api/search?q=${encodeURIComponent(searchValue)}`
      );
      const customers = await response.json();
      showCustomerDropdownForStock(customers, inputElement, fieldType);
    } catch (error) {
      console.error("Error searching customers:", error);
      hideCustomerDropdown(inputElement);
    }
  }

  function showCustomerDropdownForStock(customers, inputElement, fieldType) {
    hideCustomerDropdown(inputElement);

    if (customers.length === 0) {
      return;
    }

    const dropdown = document.createElement("div");
    dropdown.className = "customer-dropdown-results";
    dropdown.style.cssText = `
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--dark-card);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1050;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    `;

    customers.forEach((customer) => {
      const item = document.createElement("div");
      item.className = "customer-dropdown-item";
      item.style.cssText = `
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
        color: var(--text-light);
      `;

      item.innerHTML = `
        <div style="font-weight: 600;">${customer.account_number} - ${
        customer.name
      }</div>
        <small style="color: var(--text-muted);">
          ${customer.contact_name ? "Contact: " + customer.contact_name : ""}
        </small>
      `;

      item.addEventListener("mouseenter", function () {
        this.style.backgroundColor = "var(--primary-blue)";
      });

      item.addEventListener("mouseleave", function () {
        this.style.backgroundColor = "";
      });

      item.addEventListener("mousedown", function (e) {
        e.preventDefault();
        selectCustomerForStock(customer);
      });

      dropdown.appendChild(item);
    });

    inputElement.parentElement.appendChild(dropdown);
  }

  function selectCustomerForStock(customer) {
    console.log("✅ Selected customer:", customer);

    selectedCustomerId = customer.id;
    selectedCustomerName = customer.name;

    document.getElementById("newStockCustomerAccount").value =
      customer.account_number;
    document.getElementById("newStockCustomerName").value = customer.name;
    document.getElementById("newStockCustomerId").value = customer.id;

    const infoDiv = document.getElementById("selectedCustomerInfo");
    document.getElementById("selectedCustomerDetails").innerHTML = `
      <strong>${customer.account_number}</strong> - ${customer.name}<br>
      <small>${customer.contact_name || ""}</small>
    `;
    infoDiv.style.display = "block";

    hideCustomerDropdown(document.getElementById("newStockCustomerAccount"));
    hideCustomerDropdown(document.getElementById("newStockCustomerName"));

    loadAddressesForNewStock(customer.id, customer.name);
  }

  function clearSelectedCustomer() {
    selectedCustomerId = null;
    selectedCustomerName = null;
    document.getElementById("newStockCustomerId").value = "";
    document.getElementById("selectedCustomerInfo").style.display = "none";
    document.getElementById("addStockAddressContainer").innerHTML = "";
  }

  function hideCustomerDropdown(inputElement) {
    const existing = inputElement.parentElement.querySelector(
      ".customer-dropdown-results"
    );
    if (existing) {3
      existing.remove();
    }
  }

  // ==================== ADDRESS HANDLING ====================

  async function loadAddressesForNewStock(customerId, customerName) {
    const container = document.getElementById("addStockAddressContainer");

    try {
      const response = await fetch(`/customers/api/${customerId}/addresses`);
      const addresses = await response.json();

      console.log("📍 Customer has", addresses.length, "address(es)");
      showAddStockAddressSelector(container, addresses, customerName);
    } catch (error) {
      console.error("Error loading addresses:", error);
      container.innerHTML =
        '<div class="alert alert-danger">Error loading addresses</div>';
    }
  }

  function showAddStockAddressSelector(container, addresses, customerName) {
    const hasAddresses = addresses.length > 0;
    const autoSelectFirst = addresses.length === 1;

    container.innerHTML = `
      <div class="address-selector-wrapper mb-3" style="background: var(--dark-card, #f8f9fa); padding: 15px; border-radius: 8px; border: 2px solid var(--border-color, #dee2e6);">
        ${
          !hasAddresses
            ? `
          <div class="alert alert-warning mb-3">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>No Address on File</strong><br>
            <small>This customer doesn't have any saved addresses. Please add one below.</small>
          </div>
        `
            : ""
        }
        
        <label class="form-label" style="font-weight: 600; color: var(--text-light, #333);">
          <i class="bi bi-geo-alt-fill"></i> Default Delivery Location
        </label>
        <select class="form-select add-stock-address-select" style="margin-bottom: 10px;">
          <option value="">Choose location...</option>
          ${addresses
            .map(
              (addr, idx) => `
            <option value="${idx}" ${
                autoSelectFirst && idx === 0 ? "selected" : ""
              }>
              📍 ${addr.label}${addr.street ? " - " + addr.street : ""}${
                addr.city ? ", " + addr.city : ""
              }
            </option>
          `
            )
            .join("")}
          <option value="new" style="font-weight: 600; color: #28a745;">➕ Add New Address</option>
        </select>
        <small class="text-muted">This will be the default location for this stock item</small>
        
        <div class="selected-address-display mt-2" style="${
          autoSelectFirst ? "display: block;" : "display: none;"
        }">
          ${
            autoSelectFirst
              ? `
            <div class="alert alert-success" style="margin-top: 10px;">
              <i class="bi bi-check-circle-fill"></i> <strong>${
                addresses[0].label
              }</strong><br>
              <small>${formatAddStockAddress(addresses[0])}</small>
            </div>
          `
              : ""
          }
        </div>
        <div class="new-address-form mt-3" style="display: none;"></div>
      </div>
    `;

    const select = container.querySelector(".add-stock-address-select");
    const displayDiv = container.querySelector(".selected-address-display");
    const newAddressDiv = container.querySelector(".new-address-form");

    select.addEventListener("change", function () {
      const selectedValue = this.value;

      if (selectedValue === "new") {
        displayDiv.style.display = "none";
        showAddStockAddressForm(newAddressDiv, customerName);
      } else if (selectedValue === "") {
        displayDiv.style.display = "none";
        newAddressDiv.innerHTML = "";
      } else {
        const idx = parseInt(selectedValue);
        const selectedAddress = addresses[idx];

        displayDiv.innerHTML = `
          <div class="alert alert-success" style="margin-top: 10px;">
            <i class="bi bi-check-circle-fill"></i> <strong>${
              selectedAddress.label
            }</strong><br>
            <small>${formatAddStockAddress(selectedAddress)}</small>
          </div>
        `;
        displayDiv.style.display = "block";
        newAddressDiv.innerHTML = "";
      }
    });
  }

  function showAddStockAddressForm(container, customerName) {
    container.innerHTML = `
      <div class="alert alert-info">
        <i class="bi bi-plus-circle"></i> <strong>Add New Delivery Address</strong>
        <p class="mb-0 mt-2 small">This address will be saved to ${customerName}'s account.</p>
      </div>
      <div class="mb-2">
        <label class="form-label">Location Name *</label>
        <input type="text" class="form-control new-address-label" placeholder="e.g., Warehouse 2, Kitchen" required>
      </div>
      <div class="mb-2">
        <label class="form-label">Street Address</label>
        <input type="text" class="form-control new-address-street" placeholder="123 High Street">
      </div>
      <div class="row">
        <div class="col-md-6 mb-2">
          <label class="form-label">City/Town</label>
          <input type="text" class="form-control new-address-city" placeholder="Glasgow">
        </div>
        <div class="col-md-6 mb-2">
          <label class="form-label">Postcode</label>
          <input type="text" class="form-control new-address-zip" placeholder="G1 1AA">
        </div>
      </div>
      <div class="mb-2">
        <label class="form-label">Phone Number</label>
        <input type="text" class="form-control new-address-phone" placeholder="01234 567890">
      </div>
    `;
    container.style.display = "block";
  }

  function formatAddStockAddress(address) {
    const parts = [];
    if (address.street) parts.push(address.street);
    if (address.city) parts.push(address.city);
    if (address.zip) parts.push(address.zip);
    return parts.length > 0 ? parts.join(", ") : "Address not specified";
  }

  function getAddStockSelectedAddress() {
    const container = document.getElementById("addStockAddressContainer");
    const select = container.querySelector(".add-stock-address-select");

    if (!select) return null;

    const selectedValue = select.value;

    if (selectedValue === "new") {
      return {
        label:
          container.querySelector(".new-address-label")?.value.trim() || "",
        street:
          container.querySelector(".new-address-street")?.value.trim() || "",
        city: container.querySelector(".new-address-city")?.value.trim() || "",
        zip: container.querySelector(".new-address-zip")?.value.trim() || "",
        phone:
          container.querySelector(".new-address-phone")?.value.trim() || "",
        isNew: true,
      };
    } else if (selectedValue && selectedValue !== "") {
      const option = select.options[select.selectedIndex];
      const labelMatch = option.text.match(/📍\s*(.+?)(?:\s*-|$)/);
      return {
        label: labelMatch ? labelMatch[1].trim() : "",
        isNew: false,
      };
    }

    return null;
  }

  // ==================== SAVE NEW STOCK ====================

  async function saveNewStock() {
    if (!selectedCustomerId) {
      alert("Please select a customer first");
      return;
    }

    const productName = document.getElementById("newStockProductName").value;
    if (!productName) {
      alert("Please fill in the product name");
      return;
    }

    const addressData = getAddStockSelectedAddress();

    const data = {
      customer_id: selectedCustomerId,
      product_code:
        document.getElementById("newStockProductCode").value || null,
      product_name: productName,
      initial_stock:
        parseInt(document.getElementById("newStockInitial").value) || 0,
      reorder_level:
        parseInt(document.getElementById("newStockReorderLevel").value) || 5,
      invoice_number: document.getElementById("newStockInvoiceNumber").value,
      notes: document.getElementById("newStockNotes").value,
    };

    if (addressData) {
      if (addressData.isNew) {
        if (!addressData.label) {
          alert("Please provide a location name for the new address");
          return;
        }
        data.address_label = "__NEW__";
        data.new_address = addressData;
      } else {
        data.address_label = addressData.label;
      }
    }

    try {
      const response = await fetch("/customer-stock/api/customer-stock", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        console.error("❌ API Error:", response.status);
        const text = await response.text();
        console.error("Response:", text);
        throw new Error(`Server returned ${response.status}`);
      }

      const result = await response.json();

      if (result.success) {
        addStockModal.hide();
        location.reload();
      } else {
        alert("Error: " + result.message);
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error: " + error.message);
    }
  }

  // ==================== STOCK IN MODAL ====================

  function showStockInModal(itemId, customer, product) {
    document.getElementById("stockInItemId").value = itemId;
    document.getElementById("stockInCustomer").textContent = customer;
    document.getElementById("stockInProduct").textContent = product;
    document.getElementById("stockInQuantity").value = "";
    document.getElementById("stockInInvoiceNumber").value = "";
    document.getElementById("stockInNotes").value = "";
    stockInModal.show();
  }

  async function processStockIn() {
    const itemId = document.getElementById("stockInItemId").value;
    const data = {
      transaction_type: "stock_in",
      quantity: parseInt(document.getElementById("stockInQuantity").value),
      reference: document.getElementById("stockInInvoiceNumber").value,
      notes: document.getElementById("stockInNotes").value,
    };

    if (!data.quantity || data.quantity < 1) {
      alert("Please enter a valid quantity");
      return;
    }

    try {
      const response = await fetch(
        `/customer-stock/api/customer-stock/${itemId}/transaction`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        }
      );

      if (!response.ok) {
        console.error("❌ API Error:", response.status);
        const text = await response.text();
        console.error("Response:", text);
        throw new Error(`Server returned ${response.status}`);
      }

      const result = await response.json();
      if (result.success) {
        stockInModal.hide();
        location.reload();
      } else {
        alert("Error: " + result.message);
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error: " + error.message);
    }
  }

  // ==================== STOCK HISTORY ====================

  async function showStockHistory(itemId) {
    try {
      const response = await fetch(
        `/customer-stock/api/customer-stock/${itemId}/history`
      );

      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`);
      }

      const transactions = await response.json();

      let historyHtml =
        '<div class="table-responsive"><table class="table"><thead><tr><th>Date</th><th>Type</th><th>Quantity</th><th>Reference</th><th>Notes</th><th>User</th></tr></thead><tbody>';

      transactions.forEach((transaction) => {
        const date = new Date(transaction.transaction_date).toLocaleString();
        const badgeClass =
          transaction.transaction_type === "stock_in"
            ? "bg-success"
            : transaction.transaction_type === "stock_out"
            ? "bg-danger"
            : "bg-warning";

        historyHtml += `
          <tr>
            <td>${date}</td>
            <td><span class="badge ${badgeClass}">${transaction.transaction_type.replace(
          "_",
          " "
        )}</span></td>
            <td>${transaction.quantity > 0 ? "+" : ""}${
          transaction.quantity
        }</td>
            <td>${transaction.reference || "-"}</td>
            <td>${transaction.notes || "-"}</td>
            <td>${transaction.user ? transaction.user.username : "-"}</td>
          </tr>
        `;
      });

      historyHtml += "</tbody></table></div>";

      document.getElementById("historyContent").innerHTML = historyHtml;
      stockHistoryModal.show();
    } catch (error) {
      console.error("Error:", error);
      alert("Error loading history: " + error.message);
    }
  }

  // ==================== EDIT STOCK ITEM ====================

  function editStockItem(itemId) {
    alert("Edit functionality coming soon for item " + itemId);
  }
</script>

{% endblock %}
