{% extends "base.html" %} {% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>New Standing Order</h2>
  <a href="{{ url_for('main.standing_orders') }}" class="btn btn-secondary">
    <i class="bi bi-arrow-left"></i> Back
  </a>
</div>

<div class="card">
  <div class="card-body">
    <form id="standingOrderForm">
      <!-- Customer Selection -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="search-container position-relative">
            <label class="form-label">Customer Account *</label>
            <input
              type="text"
              class="form-control"
              id="customerAccount"
              name="customer_account"
              placeholder="Start typing account number..."
              required
            />
            <input type="hidden" id="customerId" name="customer_id" />
          </div>
        </div>
        <div class="col-md-4">
          <div class="search-container position-relative">
            <label class="form-label">Customer Name *</label>
            <input
              type="text"
              class="form-control"
              id="customerName"
              name="customer_name"
              placeholder="Start typing customer name..."
              required
            />
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Customer Address</label>
          <input
            type="text"
            class="form-control"
            id="customerAddress"
            name="customer_address"
            placeholder="Customer address will auto-fill"
            required
          />
        </div>
      </div>

      <!-- Delivery Days -->
      <div class="mb-4">
        <label class="form-label">Delivery Days * (Weekly)</label>
        <div class="btn-group-toggle" data-toggle="buttons">
          <div class="d-flex gap-2 flex-wrap">
            <label class="btn btn-outline-primary">
              <input type="checkbox" name="deliveryDays" value="0" /> Monday
            </label>
            <label class="btn btn-outline-primary">
              <input type="checkbox" name="deliveryDays" value="1" /> Tuesday
            </label>
            <label class="btn btn-outline-primary">
              <input type="checkbox" name="deliveryDays" value="2" /> Wednesday
            </label>
            <label class="btn btn-outline-primary">
              <input type="checkbox" name="deliveryDays" value="3" /> Thursday
            </label>
            <label class="btn btn-outline-primary">
              <input type="checkbox" name="deliveryDays" value="4" /> Friday
            </label>
          </div>
        </div>
        <small class="text-muted"
          >Standing order will start from the next occurrence of the selected
          day(s)</small
        >
      </div>

      <!-- End Date Only -->
      <div class="row mb-4">
        <div class="col-md-6">
          <label class="form-label">End Date (leave blank for ongoing)</label>
          <input type="date" class="form-control" id="endDate" />
          <small class="text-muted"
            >Only use if standing order has a specific end date (e.g., 1 month
            trial)</small
          >
        </div>
      </div>

      <!-- Products -->
      <div class="mb-4">
        <h5>Products</h5>
        <div id="productsContainer">
          <!-- Products will be added here -->
        </div>
        <button
          type="button"
          class="btn btn-success mt-2"
          onclick="addProductRow()"
        >
          <i class="bi bi-plus"></i> Add Product
        </button>
      </div>

      <!-- Special Instructions -->
      <div class="mb-4">
        <label class="form-label">Special Instructions</label>
        <textarea
          class="form-control"
          id="specialInstructions"
          rows="3"
          placeholder="Any special delivery instructions or notes"
        ></textarea>
      </div>

      <!-- Submit Buttons -->
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check-circle"></i> Create Standing Order
        </button>
        <a
          href="{{ url_for('main.standing_orders') }}"
          class="btn btn-secondary"
        >
          Cancel
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Product Row Template -->
<template id="productRowTemplate">
  <div class="product-row border rounded p-3 mb-2">
    <div class="row">
      <div class="col-md-4">
        <div class="search-container position-relative">
          <label class="form-label">Product Code *</label>
          <input
            type="text"
            class="form-control product-code"
            placeholder="Start typing product code..."
            required
          />
        </div>
      </div>
      <div class="col-md-5">
        <label class="form-label">Product Name *</label>
        <input
          type="text"
          class="form-control product-name"
          placeholder="Product description"
          required
        />
      </div>
      <div class="col-md-2">
        <label class="form-label">Quantity *</label>
        <input
          type="number"
          class="form-control product-quantity"
          min="1"
          placeholder="Qty"
          required
        />
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button
          type="button"
          class="btn btn-danger btn-sm"
          onclick="removeProductRow(this)"
        >
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
  </div>
</template>

{% endblock %} {% block scripts %}
<script type="module">
  import { extractProductCode, debounce } from "/static/js/script.js";

  let productSearchTimeout;

  document.addEventListener(
    "DOMContentLoaded",
    function () {
      setupCustomerSearch();

      document
        .querySelectorAll('input[name="deliveryDays"]')
        .forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            const label = this.parentElement;
            if (this.checked) {
              label.classList.remove("btn-outline-primary");
              label.classList.add("btn-primary");
            } else {
              label.classList.remove("btn-primary");
              label.classList.add("btn-outline-primary");
            }
          });
        });

      document
        .getElementById("standingOrderForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Prevent double submission
          const submitBtn = this.querySelector('button[type="submit"]');
          if (submitBtn.disabled) return;
          submitBtn.disabled = true;

          const deliveryDays = Array.from(
            document.querySelectorAll('input[name="deliveryDays"]:checked')
          ).map((cb) => cb.value);

          if (deliveryDays.length === 0) {
            alert("Please select at least one delivery day");
            submitBtn.disabled = false;
            return;
          }

          const weekendDays = deliveryDays.filter((day) => parseInt(day) >= 5);
          if (weekendDays.length > 0) {
            alert(
              "Weekend deliveries are not supported. Please select Monday through Friday only."
            );
            submitBtn.disabled = false;
            return;
          }

          const productRows = document.querySelectorAll(".product-row");
          if (productRows.length === 0) {
            alert("Please add at least one product");
            submitBtn.disabled = false;
            return;
          }

          const products = [];
          let hasError = false;

          productRows.forEach((row) => {
            const code = row.querySelector(".product-code").value.trim();
            const name = row.querySelector(".product-name").value.trim();
            const quantity = row.querySelector(".product-quantity").value;

            if (!code || !name || !quantity) {
              hasError = true;
              return;
            }

            products.push({
              product_code: code,
              product_name: name,
              quantity: parseInt(quantity),
            });
          });

          if (hasError) {
            alert("Please fill in all product fields");
            submitBtn.disabled = false;
            return;
          }

          const formData = {
            customer_id: document.getElementById("customerId").value,
            customer_account: document.getElementById("customerAccount").value,
            customer_name: document.getElementById("customerName").value,
            customer_address: document.getElementById("customerAddress").value,
            delivery_days: deliveryDays.map((d) => parseInt(d)),
            products: products,
            special_instructions: document.getElementById("specialInstructions")
              .value,
          };

          try {
            const response = await fetch("/api/standing-orders", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (data.success) {
              window.location.href = "/standing-orders";
            } else {
              alert(data.message || "Error creating standing order");
              submitBtn.disabled = false;
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Error creating standing order");
            submitBtn.disabled = false;
          }
        });
    },
    { once: true }
  );

  function setupCustomerSearch() {
    const accountInput = document.getElementById("customerAccount");
    const nameInput = document.getElementById("customerName");

    if (accountInput) {
      accountInput.addEventListener(
        "input",
        debounce(function () {
          if (this.value.length >= 2) {
            searchCustomers(this.value, "account");
          } else {
            hideCustomerDropdown();
          }
        }, 300)
      );
    }

    if (nameInput) {
      nameInput.addEventListener(
        "input",
        debounce(function () {
          if (this.value.length >= 2) {
            searchCustomers(this.value, "name");
          } else {
            hideCustomerDropdown();
          }
        }, 300)
      );
    }

    document.addEventListener("click", function (e) {
      if (!e.target.closest(".search-container")) {
        hideCustomerDropdown();
      }
    });
  }

  async function searchCustomers(query, searchType) {
    try {
      const response = await fetch(
        `/api/customers/search?q=${encodeURIComponent(query)}`
      );
      const customers = await response.json();

      if (customers.length > 0) {
        showCustomerDropdown(customers, searchType);
      } else {
        hideCustomerDropdown();
      }
    } catch (error) {
      console.error("Error searching customers:", error);
    }
  }

  function showCustomerDropdown(customers, searchType) {
    hideCustomerDropdown();

    const targetInput =
      searchType === "account"
        ? document.getElementById("customerAccount")
        : document.getElementById("customerName");
    const container = targetInput.parentElement;

    const dropdown = document.createElement("div");
    dropdown.className = "dropdown-results";
    dropdown.style.position = "absolute";
    dropdown.style.top = "100%";
    dropdown.style.left = "0";
    dropdown.style.right = "0";
    dropdown.style.zIndex = "1000";
    dropdown.style.maxHeight = "300px";
    dropdown.style.overflowY = "auto";
    dropdown.style.backgroundColor = "white";
    dropdown.style.border = "1px solid #ddd";
    dropdown.style.borderRadius = "4px";
    dropdown.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";

    customers.forEach((customer) => {
      const item = document.createElement("div");
      item.className = "dropdown-item";
      item.style.padding = "10px";
      item.style.cursor = "pointer";
      item.innerHTML = `
        <strong>${customer.name}</strong>
        <div style="font-size: 0.85em; color: #666;">
          Account: ${customer.account_number}
        </div>
      `;

      item.addEventListener("mouseenter", function () {
        this.style.backgroundColor = "#f8f9fa";
      });

      item.addEventListener("mouseleave", function () {
        this.style.backgroundColor = "transparent";
      });

      item.addEventListener("click", function () {
        selectCustomer(customer);
      });

      dropdown.appendChild(item);
    });

    container.appendChild(dropdown);
  }

  function hideCustomerDropdown() {
    const existing = document.querySelector(".dropdown-results");
    if (existing) {
      existing.remove();
    }
  }

  function selectCustomer(customer) {
    document.getElementById("customerId").value = customer.id;
    document.getElementById("customerAccount").value = customer.account_number;
    document.getElementById("customerName").value = customer.name;
    document.getElementById("customerAddress").value = customer.address || "";

    hideCustomerDropdown();
  }

  function setupProductSearch(inputElement) {
    if (!inputElement) return;

    inputElement.addEventListener(
      "input",
      debounce(function () {
        if (this.value.length >= 2) {
          searchProducts(this.value, this);
        } else {
          hideDropdown(this);
        }
      }, 300)
    );

    inputElement.addEventListener("blur", function () {
      setTimeout(() => {
        if (!document.querySelector(".dropdown-results:hover")) {
          hideDropdown(this);
        }
      }, 200);
    });
  }

  async function searchProducts(query, inputElement) {
    try {
      const response = await fetch(
        `/api/products/search?q=${encodeURIComponent(query)}`
      );
      const products = await response.json();

      if (products.length > 0) {
        showProductDropdown(products, inputElement);
      } else {
        hideDropdown(inputElement);
      }
    } catch (error) {
      console.error("Error searching products:", error);
    }
  }

  function showProductDropdown(products, inputElement) {
    hideDropdown(inputElement);

    const dropdown = document.createElement("div");
    dropdown.className = "dropdown-results";
    dropdown.style.position = "absolute";
    dropdown.style.zIndex = "1000";
    dropdown.style.backgroundColor = "white";
    dropdown.style.border = "1px solid #ddd";
    dropdown.style.borderRadius = "4px";
    dropdown.style.maxWidth = "500px";
    dropdown.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
    dropdown.style.maxHeight = "300px";
    dropdown.style.overflowY = "auto";

    products.forEach((product) => {
      const item = document.createElement("div");
      item.className = "dropdown-item";
      item.style.padding = "8px 12px";
      item.style.cursor = "pointer";
      item.innerHTML = `
        <strong>${product.code}</strong>
        <div style="font-size: 0.85em; color: #666;">${product.name}</div>
      `;

      item.addEventListener("mouseenter", function () {
        this.style.backgroundColor = "#f8f9fa";
      });

      item.addEventListener("mouseleave", function () {
        this.style.backgroundColor = "transparent";
      });

      item.addEventListener("click", function () {
        selectProduct(product, inputElement);
        hideDropdown(inputElement);
      });

      dropdown.appendChild(item);
    });

    inputElement.parentElement.appendChild(dropdown);
  }

  function selectProduct(product, inputElement) {
    const productRow = inputElement.closest(".product-row");
    const codeInput = productRow.querySelector(".product-code");
    const nameInput = productRow.querySelector(".product-name");

    if (codeInput) {
      codeInput.value = product.code;
    }

    if (nameInput) {
      nameInput.value = product.name;
    }
  }

  function hideDropdown(inputElement) {
    const existing =
      inputElement.parentElement.querySelector(".dropdown-results");
    if (existing) {
      existing.remove();
    }
  }

  window.addProductRow = function (
    productCode = "",
    productName = "",
    quantity = 1
  ) {
    const template = document.getElementById("productRowTemplate");
    const clone = template.content.cloneNode(true);

    const codeInput = clone.querySelector(".product-code");
    const nameInput = clone.querySelector(".product-name");
    const quantityInput = clone.querySelector(".product-quantity");

    if (productCode) codeInput.value = productCode;
    if (productName) nameInput.value = productName;
    if (quantity) quantityInput.value = quantity;

    document.getElementById("productsContainer").appendChild(clone);

    const newProductRows = document.querySelectorAll(".product-row");
    const latestRow = newProductRows[newProductRows.length - 1];
    const newProductCodeInput = latestRow.querySelector(".product-code");

    if (newProductCodeInput) {
      setupProductSearch(newProductCodeInput);
    }
  };

  window.removeProductRow = function (button) {
    button.closest(".product-row").remove();
  };
</script>
{% endblock %}
