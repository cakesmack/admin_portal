{% extends "base.html" %}
{% block content %}
<h2>Create Standing Order</h2>
<p class="text-muted">Set up recurring weekly deliveries for customers</p>

<div class="card mt-4">
  <div class="card-body">
    <form method="POST" id="standingOrderForm">
      
      <!-- Customer Details -->
      <div class="row mb-4">
        <div class="col-12">
          <h5 class="border-bottom pb-2 mb-3">Customer Details</h5>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <div class="search-container position-relative">
            <label class="form-label">Customer Account Number *</label>
            <input type="text" name="customer_account" class="form-control" placeholder="Start typing account..." required>
            <input type="hidden" name="customer_id" id="customerId">
          </div>
        </div>
        <div class="col-md-4">
          <div class="search-container position-relative">
            <label class="form-label">Customer Name *</label>
            <input type="text" name="customer_name" class="form-control" placeholder="Start typing name..." required>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Delivery Address</label>
          <input type="text" name="customer_address" class="form-control" placeholder="Address" readonly>
        </div>
      </div>

      <!-- Address Selection Container -->
      <div id="addressSelectionContainer" class="address-selection-area mb-3"></div>

      <!-- Delivery Schedule -->
      <div class="row mb-4">
        <div class="col-12">
          <h5 class="border-bottom pb-2 mb-3">Delivery Schedule</h5>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Delivery Days (Select one or more) *</label>
        <div class="btn-group d-flex flex-wrap" role="group">
          <input type="checkbox" class="btn-check" name="deliveryDays" value="0" id="monday">
          <label class="btn btn-outline-primary" for="monday">Monday</label>

          <input type="checkbox" class="btn-check" name="deliveryDays" value="1" id="tuesday">
          <label class="btn btn-outline-primary" for="tuesday">Tuesday</label>

          <input type="checkbox" class="btn-check" name="deliveryDays" value="2" id="wednesday">
          <label class="btn btn-outline-primary" for="wednesday">Wednesday</label>

          <input type="checkbox" class="btn-check" name="deliveryDays" value="3" id="thursday">
          <label class="btn btn-outline-primary" for="thursday">Thursday</label>

          <input type="checkbox" class="btn-check" name="deliveryDays" value="4" id="friday">
          <label class="btn btn-outline-primary" for="friday">Friday</label>
        </div>
        <small class="text-muted">Weekend deliveries are not supported</small>
      </div>

      <!-- Product Details -->
      <div class="row mb-4">
        <div class="col-12">
          <h5 class="border-bottom pb-2 mb-3">Products</h5>
        </div>
      </div>

      <div id="products-container"></div>

      <div class="mb-3">
        <button type="button" class="btn btn-success" onclick="addProductRow()">
          <i class="bi bi-plus-circle"></i> Add Product
        </button>
      </div>

      <!-- Special Instructions -->
      <div class="mb-4">
        <label class="form-label">Special Instructions</label>
        <textarea class="form-control" name="specialInstructions" rows="3" placeholder="Any special delivery instructions or notes"></textarea>
      </div>

      <!-- Submit Buttons -->
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check-circle"></i> Create Standing Order
        </button>
        <a href="{{ url_for('standing_orders.standing_orders') }}" class="btn btn-secondary">
          Cancel
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Product Row Template -->
<template id="productRowTemplate">
  <div class="product-row border rounded p-3 mb-2">
    <div class="row">
      <div class="col-md-4">
        <div class="search-container position-relative">
          <label class="form-label">Product Code *</label>
          <input type="text" class="form-control product-code" placeholder="Start typing product code..." required>
        </div>
      </div>
      <div class="col-md-5">
        <label class="form-label">Product Name *</label>
        <input type="text" class="form-control product-name" placeholder="Product description" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Quantity *</label>
        <input type="number" class="form-control product-quantity" min="1" placeholder="Qty" required>
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button type="button" class="btn btn-danger btn-sm" onclick="removeProductRow(this)">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
  </div>
</template>

{% endblock %}

{% block scripts %}
<script type="module">
  import { 
    initCustomerSearch, 
    initProductSearch,
    getSelectedAddress,
    getSelectedCustomer
  } from "/static/js/script.js";

  document.addEventListener("DOMContentLoaded", function () {
    // Initialize customer search with callback to store customer ID
    initCustomerSearch({
      accountInputId: "customer_account",
      nameInputId: "customer_name",
      addressInputId: "customer_address",
      addressContainerId: "addressSelectionContainer",
      onSelect: (customer) => {
        document.getElementById("customerId").value = customer.id;
      }
    });

    // Style delivery day checkboxes
    document.querySelectorAll('input[name="deliveryDays"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const label = this.parentElement;
        if (this.checked) {
          label.classList.remove('btn-outline-primary');
          label.classList.add('btn-primary');
        } else {
          label.classList.remove('btn-primary');
          label.classList.add('btn-outline-primary');
        }
      });
    });

    // Add first product row automatically
    window.addProductRow();

    // Handle form submission
    const form = document.getElementById("standingOrderForm");
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      // Validate delivery days
      const deliveryDays = Array.from(document.querySelectorAll('input[name="deliveryDays"]:checked')).map(cb => cb.value);
      
      if (deliveryDays.length === 0) {
        alert('Please select at least one delivery day');
        return;
      }

      // Collect products as "items" (backend expects "items" not "products")
      const items = [];
      document.querySelectorAll('.product-row').forEach(row => {
        const code = row.querySelector('.product-code').value.trim();
        const name = row.querySelector('.product-name').value.trim();
        const quantity = row.querySelector('.product-quantity').value;

        if (code && name && quantity) {
          items.push({
            product_code: code,
            product_name: name,
            quantity: parseInt(quantity)
          });
        }
      });

      if (items.length === 0) {
        alert('Please add at least one product');
        return;
      }

      // Get selected address
      const addressContainer = document.getElementById("addressSelectionContainer");
      const selectedAddressData = getSelectedAddress(addressContainer);

      // Prepare form data - IMPORTANT: Format matches what backend expects
      const formData = {
        customer_id: document.getElementById("customerId").value,
        customer_name: document.querySelector('input[name="customer_name"]').value,
        delivery_days: deliveryDays,  // Send as array, backend will join
        special_instructions: document.querySelector('textarea[name="specialInstructions"]').value,
        items: items  // Backend expects "items" not "products"
      };

      // Add address label if selected
      if (selectedAddressData && selectedAddressData.label) {
        formData.address_label = selectedAddressData.label;
      }

      try {
        // POST to /standing-orders/new (not /api/standing-orders)
        const response = await fetch('/standing-orders/new', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.success) {
          alert('Standing order created successfully!');
          window.location.href = '/standing-orders';
        } else {
          alert('Error: ' + result.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error creating standing order. Please try again.');
      }
    });
  });

  // Make functions global for onclick handlers
  window.addProductRow = async function() {
    const { initProductSearch } = await import("/static/js/script.js");
    
    const container = document.getElementById('products-container');
    const template = document.getElementById('productRowTemplate');
    const clone = template.content.cloneNode(true);
    
    container.appendChild(clone);

    // Initialize product search for the new row
    const newRow = container.lastElementChild;
    initProductSearch(newRow);
  };

  window.removeProductRow = function(button) {
    const row = button.closest('.product-row');
    row.remove();
  };
</script>
{% endblock %}