{% extends "base.html" %} {% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2>Clearance Stock</h2>
    <p class="text-muted">Manage and search clearance stock items</p>
  </div>
  <div>
    {% if current_user.role == 'admin' %}
    <button class="btn btn-info" onclick="showUploadModal()">
      <i class="bi bi-upload"></i> Upload Excel
    </button>
    {% endif %}
    <button class="btn btn-success" onclick="showAddModal()">
      <i class="bi bi-plus-circle"></i> Add New Item
    </button>
  </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="text-primary" id="totalItems">0</h5>
        <small>Total Items</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="text-success" id="totalUnits">0</h5>
        <small>Units Available</small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="text-info" id="totalValue">£0.00</h5>
        <small>Total Value</small>
      </div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <label class="form-label">Search</label>
        <input
          type="text"
          class="form-control"
          id="searchInput"
          placeholder="Search by code, description, or supplier"
          onkeyup="searchItems()"
        />
      </div>
      <div class="col-md-6">
        <label class="form-label">Filter by Pallet</label>
        <select
          class="form-select"
          id="palletFilter"
          onchange="filterByPallet()"
        >
          <option value="">All Pallets</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Items Table -->
<div class="card">
  <div class="card-header">
    <h5>Clearance Items</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Qty</th>
            <th>Sold</th>
            <th>Supplier Code</th>
            <th>HIS Code</th>
            <th>Description</th>
            <th>Cost Price</th>
            <th>Total Price</th>
            <th>Pallet</th>
            <th>Link</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="itemsTable">
          <tr>
            <td colspan="10" class="text-center">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Upload Modal -->
{% if current_user.role == 'admin' %}
<div class="modal fade" id="uploadModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload Clearance Stock Excel</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i>
          Upload your clearance stock Excel file (.xlsx or .xlsm). This will add
          new items and update existing ones based on supplier code.
        </div>
        <div class="mb-3">
          <label for="excelFile" class="form-label">Select Excel File</label>
          <input
            type="file"
            class="form-control"
            id="excelFile"
            accept=".xlsx,.xlsm"
          />
        </div>
        <div id="uploadProgress" class="progress" style="display: none">
          <div
            class="progress-bar progress-bar-striped progress-bar-animated"
            role="progressbar"
            style="width: 100%"
          ></div>
        </div>
        <div id="uploadResult" style="display: none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="uploadFile()">
          <i class="bi bi-upload"></i> Upload
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Add/Edit Modal -->
<div class="modal fade" id="itemModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add New Item</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="itemForm">
          <input type="hidden" id="itemId" />
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Quantity *</label>
              <input
                type="number"
                class="form-control"
                id="qty"
                required
                min="1"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Supplier Code *</label>
              <input
                type="text"
                class="form-control"
                id="supplierCode"
                required
              />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">HIS Code</label>
              <input type="text" class="form-control" id="hisCode" />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Description *</label>
            <input type="text" class="form-control" id="description" required />
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Cost Price *</label>
              <input
                type="number"
                class="form-control"
                id="costPrice"
                required
                step="0.01"
                min="0"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Pallet</label>
              <input
                type="text"
                class="form-control"
                id="pallet"
                list="palletList"
              />
              <datalist id="palletList"></datalist>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Supplier Link</label>
            <input
              type="url"
              class="form-control"
              id="supplierLink"
              placeholder="https://..."
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="saveItem()">
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Mark as Sold Modal -->
<div class="modal fade" id="soldModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Mark Items as Sold</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="soldItemId" />
        <div class="alert alert-info" id="soldItemInfo"></div>
        <div class="mb-3">
          <label class="form-label">Quantity Sold *</label>
          <input
            type="number"
            class="form-control"
            id="qtySold"
            min="1"
            required
          />
          <small class="form-text text-muted"
            >Enter how many units were sold</small
          >
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="confirmSold()">
          <i class="bi bi-check-circle"></i> Mark as Sold
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let allItems = [];
  let currentFilter = '';
  let currentSearch = '';
  let itemModal;
  let soldModal;
  let uploadModal;

  document.addEventListener('DOMContentLoaded', function() {
    itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
    soldModal = new bootstrap.Modal(document.getElementById('soldModal'));
    {% if current_user.role == 'admin' %}
    uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
    {% endif %}
    loadItems();
    loadPallets();
  });

  async function loadItems() {
    try {
      const response = await fetch('/clearance/api/clearance-stock');
      const data = await response.json();
      if (data.success) {
        allItems = data.items;
        displayItems(allItems);
        updateStats();
      }
    } catch (error) {
      console.error('Error loading items:', error);
    }
  }

  async function loadPallets() {
    try {
      const response = await fetch('/clearance/api/clearance-stock/pallets');
      const data = await response.json();
      if (data.success) {
        const palletFilter = document.getElementById('palletFilter');
        const palletList = document.getElementById('palletList');

        palletFilter.innerHTML = '<option value="">All Pallets</option>';
        palletList.innerHTML = '';

        data.pallets.forEach(pallet => {
          palletFilter.innerHTML += `<option value="${pallet}">${pallet}</option>`;
          palletList.innerHTML += `<option value="${pallet}">`;
        });
      }
    } catch (error) {
      console.error('Error loading pallets:', error);
    }
  }

  function displayItems(items) {
    const tbody = document.getElementById('itemsTable');

    if (items.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" class="text-center">No items found</td></tr>';
      return;
    }

    tbody.innerHTML = items.map(item => `
      <tr>
        <td><span class="badge bg-${item.qty === 0 ? 'danger' : item.qty <= 5 ? 'warning' : 'success'}">${item.qty}</span></td>
        <td>${item.qty_sold || 0}</td>
        <td>${item.supplier_code}</td>
        <td>${item.his_code || '-'}</td>
        <td>${item.description}</td>
        <td>£${parseFloat(item.cost_price).toFixed(2)}</td>
        <td>£${parseFloat(item.total_price || 0).toFixed(2)}</td>
        <td>${item.pallet || '-'}</td>
        <td>
          ${item.supplier_link ? `<a href="${item.supplier_link}" target="_blank" class="btn btn-sm btn-info"><i class="bi bi-link-45deg"></i></a>` : '-'}
        </td>
        <td>
          <button class="btn btn-sm btn-success" onclick="showSoldModal(${item.id}, ${item.qty}, '${item.description.replace(/'/g, "\\'")}')" ${item.qty === 0 ? 'disabled' : ''}>
            <i class="bi bi-cart-check"></i>
          </button>
          <button class="btn btn-sm btn-primary" onclick="editItem(${item.id})">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
    `).join('');
  }

  function updateStats() {
    const totalItems = allItems.length;
    const totalUnits = allItems.reduce((sum, item) => sum + item.qty, 0);
    const totalValue = allItems.reduce((sum, item) => sum + (item.total_price || 0), 0);

    document.getElementById('totalItems').textContent = totalItems;
    document.getElementById('totalUnits').textContent = totalUnits;
    document.getElementById('totalValue').textContent = `£${totalValue.toFixed(2)}`;
  }

  function searchItems() {
    currentSearch = document.getElementById('searchInput').value.toLowerCase();
    applyFilters();
  }

  function filterByPallet() {
    currentFilter = document.getElementById('palletFilter').value;
    applyFilters();
  }

  function applyFilters() {
    let filtered = allItems;

    if (currentSearch) {
      filtered = filtered.filter(item =>
        item.supplier_code.toLowerCase().includes(currentSearch) ||
        item.description.toLowerCase().includes(currentSearch) ||
        (item.his_code && item.his_code.toLowerCase().includes(currentSearch)) ||
        (item.pallet && item.pallet.toLowerCase().includes(currentSearch))
      );
    }

    if (currentFilter) {
      filtered = filtered.filter(item => item.pallet === currentFilter);
    }

    displayItems(filtered);
  }

  function showUploadModal() {
    document.getElementById('excelFile').value = '';
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadResult').style.display = 'none';
    uploadModal.show();
  }

  async function uploadFile() {
    const fileInput = document.getElementById('excelFile');
    const file = fileInput.files[0];

    if (!file) {
      alert('Please select a file');
      return;
    }

    const formData = new FormData();
    formData.append('file', file);

    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('uploadResult').style.display = 'none';

    try {
      const response = await fetch('/clearance/api/clearance-stock/upload', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      document.getElementById('uploadProgress').style.display = 'none';
      const resultDiv = document.getElementById('uploadResult');
      resultDiv.style.display = 'block';

      console.log('Upload result:', data);

      if (data.success) {
        resultDiv.className = 'alert alert-success';
        resultDiv.innerHTML = `
          <i class="bi bi-check-circle"></i>
          <strong>${data.message}</strong><br>
          ${data.items_added} items added from ${data.total_rows} rows processed
        `;

        if (data.errors && data.errors.length > 0) {
          console.error('IMPORT ERRORS:', data.errors);
          resultDiv.innerHTML += `<br><br><strong>${data.errors.length} ERRORS - Check browser console for details</strong><br>`;
          resultDiv.innerHTML += '<div style="max-height: 200px; overflow-y: auto; font-size: 11px; background: #f8f9fa; padding: 10px; border: 1px solid #ddd;">';
          data.errors.slice(0, 20).forEach(err => {
            resultDiv.innerHTML += `${err}<br>`;
          });
          if (data.errors.length > 20) {
            resultDiv.innerHTML += `<br>... and ${data.errors.length - 20} more errors (see console)`;
          }
          resultDiv.innerHTML += '</div>';
        }

        setTimeout(() => {
          uploadModal.hide();
          loadItems();
          loadPallets();
        }, 8000);
      } else {
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${data.message}`;
      }
    } catch (error) {
      document.getElementById('uploadProgress').style.display = 'none';
      const resultDiv = document.getElementById('uploadResult');
      resultDiv.style.display = 'block';
      resultDiv.className = 'alert alert-danger';
      resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Error uploading file: ${error.message}`;
    }
  }

  function showAddModal() {
    document.getElementById('modalTitle').textContent = 'Add New Item';
    document.getElementById('itemForm').reset();
    document.getElementById('itemId').value = '';
    itemModal.show();
  }

  function editItem(id) {
    const item = allItems.find(i => i.id === id);
    if (!item) return;

    document.getElementById('modalTitle').textContent = 'Edit Item';
    document.getElementById('itemId').value = item.id;
    document.getElementById('qty').value = item.qty;
    document.getElementById('supplierCode').value = item.supplier_code;
    document.getElementById('hisCode').value = item.his_code || '';
    document.getElementById('description').value = item.description;
    document.getElementById('costPrice').value = item.cost_price;
    document.getElementById('pallet').value = item.pallet || '';
    document.getElementById('supplierLink').value = item.supplier_link || '';

    itemModal.show();
  }

  async function saveItem() {
    const itemId = document.getElementById('itemId').value;
    const formData = {
      qty: document.getElementById('qty').value,
      supplier_code: document.getElementById('supplierCode').value,
      his_code: document.getElementById('hisCode').value,
      description: document.getElementById('description').value,
      cost_price: document.getElementById('costPrice').value,
      pallet: document.getElementById('pallet').value,
      supplier_link: document.getElementById('supplierLink').value
    };

    try {
      const url = itemId
        ? `/clearance/api/clearance-stock/${itemId}`
        : '/clearance/api/clearance-stock';
      const method = itemId ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      const data = await response.json();
      if (data.success) {
        itemModal.hide();
        loadItems();
        loadPallets();
      } else {
        alert('Error: ' + data.message);
      }
    } catch (error) {
      console.error('Error saving item:', error);
      alert('Failed to save item');
    }
  }

  async function deleteItem(id) {
    if (!confirm('Are you sure you want to delete this item?')) return;

    try {
      const response = await fetch(`/clearance/api/clearance-stock/${id}`, {
        method: 'DELETE'
      });

      const data = await response.json();
      if (data.success) {
        loadItems();
        loadPallets();
      } else {
        alert('Error: ' + data.message);
      }
    } catch (error) {
      console.error('Error deleting item:', error);
      alert('Failed to delete item');
    }
  }

  function showSoldModal(id, availableQty, description) {
    document.getElementById('soldItemId').value = id;
    document.getElementById('qtySold').value = '';
    document.getElementById('qtySold').max = availableQty;
    document.getElementById('soldItemInfo').innerHTML = `
      <strong>${description}</strong><br>
      Available quantity: <strong>${availableQty}</strong>
    `;
    soldModal.show();
  }

  async function confirmSold() {
    const itemId = document.getElementById('soldItemId').value;
    const qtySold = parseInt(document.getElementById('qtySold').value);

    if (!qtySold || qtySold <= 0) {
      alert('Please enter a valid quantity');
      return;
    }

    try {
      const response = await fetch(`/clearance/api/clearance-stock/${itemId}/sell`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ qty_sold: qtySold })
      });

      const data = await response.json();
      if (data.success) {
        soldModal.hide();
        loadItems();
      } else {
        alert('Error: ' + data.message);
      }
    } catch (error) {
      console.error('Error marking as sold:', error);
      alert('Failed to mark as sold');
    }
  }
</script>

{% endblock %}
