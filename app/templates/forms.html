{% extends "base.html" %} 
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>Forms Management</h2>
  <div>
    <button class="btn btn-info" onclick="toggleArchived()">
      <i class="bi bi-archive"></i> 
      {% if current_filters.show_archived %}
        Hide Archived
      {% else %}
        Show Archived
      {% endif %}
    </button>
    <button class="btn btn-secondary" onclick="resetFilters()">
      <i class="bi bi-arrow-clockwise"></i> Reset Filters
    </button>
  </div>
</div>

<!-- Filters Card -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-funnel"></i> Filters</h5>
  </div>
  <div class="card-body">
    <form method="GET" action="{{ url_for('forms.list_forms') }}" id="filterForm">
      <input type="hidden" name="show_archived" value="{{ current_filters.show_archived|lower }}">
      <div class="row">
        <div class="col-md-3 mb-3">
          <label class="form-label">Form Type</label>
          <select class="form-select" name="type" onchange="this.form.submit()">
            <option value="">All Types</option>
            {% for type in form_types %}
              <option value="{{ type }}" {% if current_filters.type == type %}selected{% endif %}>
                {{ type.replace('_', ' ').title() }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-2 mb-3">
          <label class="form-label">Date From</label>
          <input type="date" class="form-control" name="date_from" 
                 value="{{ current_filters.date_from }}" onchange="this.form.submit()">
        </div>
        
        <div class="col-md-2 mb-3">
          <label class="form-label">Date To</label>
          <input type="date" class="form-control" name="date_to" 
                 value="{{ current_filters.date_to }}" onchange="this.form.submit()">
        </div>
        
        <div class="col-md-2 mb-3">
          <label class="form-label">Submitted By</label>
          <select class="form-select" name="submitted_by" onchange="this.form.submit()">
            <option value="">All Users</option>
            {% for user in all_users %}
              <option value="{{ user.username }}" {% if current_filters.submitted_by == user.username %}selected{% endif %}>
                {{ user.username }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-3 mb-3">
          <label class="form-label">Customer Search</label>
          <div class="input-group">
            <input type="text" class="form-control" name="customer" 
                   placeholder="Account or Name" value="{{ current_filters.customer }}">
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
      </div>
      
      {% if current_filters.type or current_filters.date_from or current_filters.date_to or current_filters.submitted_by or current_filters.customer %}
      <div class="alert alert-info mt-2 mb-0">
        <strong>Active Filters:</strong>
        {% if current_filters.type %}<span class="badge bg-primary me-1">Type: {{ current_filters.type }}</span>{% endif %}
        {% if current_filters.date_from %}<span class="badge bg-primary me-1">From: {{ current_filters.date_from }}</span>{% endif %}
        {% if current_filters.date_to %}<span class="badge bg-primary me-1">To: {{ current_filters.date_to }}</span>{% endif %}
        {% if current_filters.submitted_by %}<span class="badge bg-primary me-1">By: {{ current_filters.submitted_by }}</span>{% endif %}
        {% if current_filters.customer %}<span class="badge bg-primary me-1">Customer: {{ current_filters.customer }}</span>{% endif %}
        {% if current_filters.show_archived %}<span class="badge bg-warning me-1">Showing Archived</span>{% endif %}
      </div>
      {% endif %}
    </form>
  </div>
</div>

<!-- Forms Table -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="bi bi-file-text"></i> Forms 
      <span class="badge bg-secondary">{{ forms|length }}</span>
    </h5>
  </div>
  <div class="card-body">
    {% if forms %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Type</th>
            <th>Customer</th>
            <th>Account</th>
            <th>Submitted By</th>
            <th>Date Created</th>
            <th>Status</th>
            <th width="200">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for form in forms %}
          <tr class="{% if form.is_archived %}table-secondary{% endif %}">
            <td>
              <strong>#{{ form.id }}</strong>
            </td>
            <td>
              <span class="badge bg-info">{{ form.type }}</span>
            </td>
            <td>{{ form.customer_name }}</td>
            <td>
              <code>{{ form.customer_account }}</code>
            </td>
            <td>{{ form.author }}</td>
            <td>
              <small>{{ form.date_created.strftime('%d/%m/%Y %H:%M') }}</small>
            </td>
            <td>
              {% if form.is_archived %}
                <span class="badge bg-secondary">Archived</span>
              {% elif form.is_completed %}
                <span class="badge bg-success">Completed</span>
                {% if form.completed_by %}
                  <br><small class="text-muted">by {{ form.completed_by }}</small>
                {% endif %}
              {% else %}
                <span class="badge bg-warning">Pending</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a href="{{ url_for('forms.view_form', form_id=form.id) }}" 
                   class="btn btn-info" title="View">
                  <i class="bi bi-eye"></i>
                </a>
                <a href="{{ url_for('forms.print_form', form_id=form.id) }}" 
                   class="btn btn-primary" target="_blank" title="Print">
                  <i class="bi bi-printer"></i>
                </a>
                
                {% if not form.is_archived %}
                  {% if not form.is_completed %}
                    <button class="btn btn-success" onclick="completeForm({{ form.id }})" title="Mark Complete">
                      <i class="bi bi-check-circle"></i>
                    </button>
                  {% endif %}
                  <button class="btn btn-warning" onclick="archiveForm({{ form.id }})" title="Archive">
                    <i class="bi bi-archive"></i>
                  </button>
                {% else %}
                  <button class="btn btn-secondary" onclick="unarchiveForm({{ form.id }})" title="Restore">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-4">
      <p class="text-muted">
        {% if current_filters.type or current_filters.date_from or current_filters.date_to or current_filters.submitted_by or current_filters.customer %}
          No forms found matching your filters.
        {% else %}
          No forms have been submitted yet.
        {% endif %}
      </p>
      {% if current_filters.type or current_filters.date_from or current_filters.date_to or current_filters.submitted_by or current_filters.customer %}
        <button class="btn btn-secondary" onclick="resetFilters()">Clear Filters</button>
      {% else %}
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">Go to Dashboard</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mt-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h4 class="text-primary">{{ forms|length }}</h4>
        <small>Total Forms</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h4 class="text-warning">{{ forms|selectattr('is_completed', 'equalto', False)|selectattr('is_archived', 'equalto', False)|list|length }}</h4>
        <small>Pending</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h4 class="text-success">{{ forms|selectattr('is_completed', 'equalto', True)|list|length }}</h4>
        <small>Completed</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h4 class="text-secondary">{{ forms|selectattr('is_archived', 'equalto', True)|list|length }}</h4>
        <small>Archived</small>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function completeForm(formId) {
  if (confirm('Mark this form as completed?')) {
    fetch(`/forms/${formId}/complete`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    });
  }
}

function archiveForm(formId) {
  if (confirm('Archive this form? It will be removed from the active list.')) {
    fetch(`/forms/${formId}/archive`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    });
  }
}

function unarchiveForm(formId) {
  if (confirm('Restore this form from archive?')) {
    fetch(`/forms/${formId}/unarchive`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error: ' + data.message);
      }
    });
  }
}

function resetFilters() {
  window.location.href = '{{ url_for("forms.list_forms") }}';
}

function toggleArchived() {
  const form = document.getElementById('filterForm');
  const archivedInput = form.querySelector('input[name="show_archived"]');
  archivedInput.value = archivedInput.value === 'true' ? 'false' : 'true';
  form.submit();
}
</script>
{% endblock %}