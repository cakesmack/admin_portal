// Dashboard Stats Functions{% extends "base.html" %} {% block content %}

<!-- Include Quill.js CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Hygiene & Catering Admin Portal</h2>
    <span>{{ current_date }}</span>
  </div>

  <!-- Main Content Area -->
  <div class="dashboard-content">
    <div class="row mb-3">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header updates-card">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-megaphone-fill"></i> Company Updates & Events
              </h5>
              <button
                class="btn btn-sm btn-light"
                onclick="showAddUpdateModal()"
              >
                <i class="bi bi-plus"></i> Add Update
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="updatesList">
              <!-- Updates will be loaded here -->
            </div>
          </div>
        </div>
      </div>
      <!-- Recent Activity Section -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-activity"></i> Recent Activity</h5>
          </div>
          <div class="card-body" style="max-height: 70vh; overflow-y: auto">
            <div id="recentActivityList">
              <!-- Recent activity will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="dashboard-container">
      <!-- Stats Row -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h3 class="text-primary" id="updatesThisWeek">-</h3>
              <small class="text-muted">Updates This Week</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h3 class="text-warning" id="pendingForms">-</h3>
              <small class="text-muted">Pending Forms</small>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h6 class="card-title">Weekly Activity</h6>
              <canvas id="activityChart" height="60"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Add Update Modal -->
<div class="modal fade" id="addUpdateModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Company Update</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input type="text" class="form-control" id="updateTitle" />
        </div>

        <div class="mb-3">
          <label class="form-label">Category</label>
          <select class="form-select" id="updateCategory">
            <!-- Categories will be loaded here -->
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Message</label>
          <!-- Rich Text Editor Container -->
          <div id="quillEditor" style="height: 200px"></div>
          <input type="hidden" id="updateMessage" />
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Priority</label>
              <select class="form-select" id="updatePriority">
                <option value="normal">Normal</option>
                <option value="important">Important</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <div class="form-check mt-4">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="updateSticky"
                />
                <label class="form-check-label" for="updateSticky">
                  Pin to top
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="isEvent" />
          <label class="form-check-label" for="isEvent">
            This is an event/meeting
          </label>
        </div>
        <div class="mb-3" id="eventDateContainer" style="display: none">
          <label class="form-label">Event Date & Time</label>
          <input type="datetime-local" class="form-control" id="eventDate" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="saveUpdate()">
          Post Update
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<!-- Include Quill.js -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let addUpdateModal;
  let quill;
  let activityChart;
  let categories = {};

  document.addEventListener("DOMContentLoaded", function () {
    addUpdateModal = new bootstrap.Modal(
      document.getElementById("addUpdateModal")
    );

    // Initialize Quill editor
    initializeQuillEditor();

    // Load dashboard data
    loadCategories();
    loadDashboardStats();
    loadUpdates();
    loadRecentActivity();

    // Event checkbox handler
    document.getElementById("isEvent").addEventListener("change", function () {
      const eventContainer = document.getElementById("eventDateContainer");
      eventContainer.style.display = this.checked ? "block" : "none";
    });
  });

  function initializeQuillEditor() {
    const toolbarOptions = [["bold", "italic"], ["link"], ["image"]];

    quill = new Quill("#quillEditor", {
      theme: "snow",
      modules: {
        toolbar: {
          container: toolbarOptions,
          handlers: {
            image: imageHandler,
          },
        },
      },
    });
  }

  // Custom image handler
  function imageHandler() {
    const input = document.createElement("input");
    input.setAttribute("type", "file");
    input.setAttribute("accept", "image/*");
    input.click();

    input.onchange = async () => {
      const file = input.files[0];
      if (file) {
        // Check file size (2MB limit)
        if (file.size > 2 * 1024 * 1024) {
          alert("File too large. Maximum size is 2MB.");
          return;
        }

        const formData = new FormData();
        formData.append("image", file);

        try {
          const response = await fetch("/api/upload-image", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();
          if (result.success) {
            // Insert image into editor
            const range = quill.getSelection();
            quill.insertEmbed(range.index, "image", result.image_url);
          } else {
            alert(result.message);
          }
        } catch (error) {
          console.error("Upload error:", error);
          alert("Upload failed");
        }
      }
    };
  }

  // Load Categories
  async function loadCategories() {
    try {
      const response = await fetch("/api/categories");
      categories = await response.json();

      // Populate category dropdown
      const categorySelect = document.getElementById("updateCategory");
      categorySelect.innerHTML = "";

      Object.keys(categories).forEach((key) => {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = categories[key].name;
        categorySelect.appendChild(option);
      });
    } catch (error) {
      console.error("Error loading categories:", error);
    }
  }
  async function loadDashboardStats() {
    try {
      const response = await fetch("/api/dashboard-stats");
      const stats = await response.json();

      // Update stat cards
      document.getElementById("updatesThisWeek").textContent =
        stats.updates_this_week;
      document.getElementById("pendingForms").textContent = stats.pending_forms;

      // Create activity chart
      createActivityChart(stats.weekly_activity);
    } catch (error) {
      console.error("Error loading dashboard stats:", error);
    }
  }

  function createActivityChart(data) {
    const ctx = document.getElementById("activityChart").getContext("2d");

    // Destroy existing chart if it exists
    if (activityChart) {
      activityChart.destroy();
    }

    activityChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: data.map((d) => d.day),
        datasets: [
          {
            label: "Activity",
            data: data.map((d) => d.total),
            borderColor: "#007bff",
            backgroundColor: "rgba(0, 123, 255, 0.1)",
            tension: 0.3,
            fill: true,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
            },
          },
        },
      },
    });
  }

  // Company Updates Functions
  function showAddUpdateModal() {
    // Clear previous content
    quill.setContents([]);
    document.getElementById("updateTitle").value = "";
    document.getElementById("updateCategory").value = "general";
    document.getElementById("updatePriority").value = "normal";
    document.getElementById("updateSticky").checked = false;
    document.getElementById("isEvent").checked = false;
    document.getElementById("eventDate").value = "";
    document.getElementById("eventDateContainer").style.display = "none";

    addUpdateModal.show();
  }

  async function saveUpdate() {
    const title = document.getElementById("updateTitle").value;
    const category = document.getElementById("updateCategory").value;
    const priority = document.getElementById("updatePriority").value;
    const sticky = document.getElementById("updateSticky").checked;
    const isEvent = document.getElementById("isEvent").checked;
    const eventDate = document.getElementById("eventDate").value;

    // Get message content from Quill editor
    let message = "";
    if (quill) {
      message = quill.root.innerHTML;
      // Check if the editor actually has content (not just empty tags)
      const textContent = quill.getText().trim();
      if (!textContent) {
        message = "";
      }
    }

    console.log("Debug - Title:", title);
    console.log("Debug - Message HTML:", message);
    console.log("Debug - Message Text:", quill ? quill.getText() : "No quill");

    if (title && message && quill && quill.getText().trim()) {
      try {
        const payload = {
          title: title,
          message: message,
          category: category,
          priority: priority,
          sticky: sticky,
          is_event: isEvent,
          event_date: eventDate || null,
        };

        console.log("Sending payload:", payload);

        const response = await fetch("/api/company-updates", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (response.ok) {
          loadUpdates();
          loadDashboardStats();
          loadRecentActivity();
          addUpdateModal.hide();
        } else {
          const errorData = await response.text();
          console.error("Server error:", errorData);
          alert("Error saving update: " + errorData);
        }
      } catch (error) {
        console.error("Error saving update:", error);
        alert("Error saving update: " + error.message);
      }
    } else {
      alert("Please enter a title and message");
      console.log(
        "Validation failed - Title:",
        !!title,
        "Message:",
        !!message,
        "Quill text:",
        quill ? quill.getText().trim() : "No quill"
      );
    }
  }

  async function loadUpdates() {
    try {
      const response = await fetch("/api/company-updates");
      const updates = await response.json();

      const updatesList = document.getElementById("updatesList");
      updatesList.innerHTML = "";

      if (updates.length === 0) {
        updatesList.innerHTML =
          '<p class="text-muted text-center">No updates yet. Be the first to post!</p>';
        return;
      }

      updates.forEach((update) => {
        const updateItem = document.createElement("div");
        const categoryColor = categories[update.category]?.color || "#6c757d";

        // Remove the 'border' class and apply all styling via JavaScript
        updateItem.className = "update-item rounded p-3 mb-3";
        updateItem.style.border = `1px solid ${categoryColor}`;
        updateItem.style.borderLeft = `4px solid ${categoryColor}`;

        const badge =
          update.priority === "urgent"
            ? "danger"
            : update.priority === "important"
            ? "warning"
            : "secondary";

        const timeAgo = getTimeAgo(new Date(update.created_at));

        let eventInfo = "";
        if (update.is_event && update.event_date) {
          const eventDate = new Date(update.event_date);
          eventInfo = `<div class="text-info small mb-2"><i class="bi bi-calendar-event"></i> ${eventDate.toLocaleString()}</div>`;
        }

        // Category badge
        const categoryName = categories[update.category]?.name || "General";

        updateItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="d-flex align-items-center">
                <h6 class="mb-0 me-2">${update.title}</h6>
                <span class="badge rounded-pill" style="background-color: ${categoryColor}; color: white; font-size: 0.7rem;">${categoryName}</span>
              </div>
              <div class="d-flex align-items-center">
                  ${
                    update.sticky
                      ? '<i class="bi bi-pin-angle-fill text-primary me-2" title="Pinned"></i>'
                      : ""
                  }
                  ${
                    update.is_event
                      ? '<i class="bi bi-calendar-event text-info me-2" title="Event"></i>'
                      : ""
                  }
                  <span class="badge bg-${badge}">${update.priority}</span>
                  ${
                    update.can_delete
                      ? `<button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteUpdate(${update.id})" title="Delete">
                        <i class="bi bi-trash"></i>
                      </button>`
                      : ""
                  }
              </div>
          </div>
          ${eventInfo}
          <div class="update-content">${update.message}</div>
          <div class="update-meta mt-2 pt-2" style="border-top: 2px solid ${categoryColor};">
            <small class="text-muted">Posted by ${
              update.author_name
            } • ${timeAgo}</small>
          </div>
        `;

        updatesList.appendChild(updateItem);
      });
    } catch (error) {
      console.error("Error loading updates:", error);
    }
  }

  async function deleteUpdate(id) {
    if (confirm("Delete this update?")) {
      try {
        await fetch(`/api/company-updates/${id}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
        });
        loadUpdates();
        loadDashboardStats(); // Refresh stats
        loadRecentActivity(); // Refresh activity
      } catch (error) {
        console.error("Error deleting update:", error);
      }
    }
  }

  // Recent Activity Functions
  async function loadRecentActivity() {
    try {
      const response = await fetch("/api/recent-activity");
      const activities = await response.json();

      const activityList = document.getElementById("recentActivityList");
      activityList.innerHTML = "";

      if (activities.length === 0) {
        activityList.innerHTML =
          '<p class="text-muted text-center">No recent activity</p>';
        return;
      }

      activities.forEach((activity) => {
        const activityItem = document.createElement("div");
        activityItem.className = "activity-item border-bottom pb-2 mb-2";

        const timeAgo = getTimeAgo(new Date(activity.timestamp));
        const linkHtml = activity.link
          ? `<a href="${activity.link}" class="text-decoration-none">`
          : "<span>";
        const linkCloseHtml = activity.link ? "</a>" : "</span>";

        activityItem.innerHTML = `
          <div class="d-flex align-items-start">
            <i class="${activity.icon} text-primary me-2 mt-1"></i>
            <div class="flex-fill">
              ${linkHtml}
                <div class="small">${activity.description}</div>
                <div class="text-muted" style="font-size: 0.75rem;">
                  by ${activity.user} • ${timeAgo}
                </div>
              ${linkCloseHtml}
            </div>
          </div>
        `;

        activityList.appendChild(activityItem);
      });
    } catch (error) {
      console.error("Error loading recent activity:", error);
    }
  }

  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";

    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";

    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";

    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";

    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";

    return "Just now";
  }
</script>
{% endblock %}
