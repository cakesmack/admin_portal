{% extends "base.html" %} {% block content %}

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Dashboard - Welcome, {{ current_user.username }}</h2>
    <span class="text-muted">{{ current_date }}</span>
  </div>

  <div class="dashboard-container">
    <!-- Main Content Area -->
    <div class="dashboard-content">
      <!-- Company Updates Section -->
      <div class="row mb-3">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header updates-card">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="bi bi-megaphone-fill"></i> Company Updates & Events
                </h5>
                <button
                  class="btn btn-sm btn-light"
                  onclick="showAddUpdateModal()"
                >
                  <i class="bi bi-plus"></i> Add Update
                </button>
              </div>
            </div>
            <div class="card-body" style="max-height: 100vh; overflow-y: auto">
              <div id="updatesList">
                <!-- Updates will be loaded here -->
              </div>
            </div>
          </div>
        </div>
        <!-- Recent Forms Section -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">
                <i class="bi bi-file-text-fill"></i> Recent Forms
              </h5>
            </div>
            <div class="card-body" style="max-height: 100vh; overflow-y: auto">
              <div id="recentFormsList">
                <!-- Recent forms will be loaded here -->
              </div>
              <div class="text-center mt-3">
                <a
                  href="{{ url_for('main.forms') }}"
                  class="btn btn-outline-primary"
                >
                  <i class="bi bi-folder-open"></i> View All Forms
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Update Modal -->
<div class="modal fade" id="addUpdateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Company Update</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input type="text" class="form-control" id="updateTitle" />
        </div>
        <div class="mb-3">
          <label class="form-label">Message</label>
          <textarea class="form-control" id="updateMessage" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Priority</label>
          <select class="form-select" id="updatePriority">
            <option value="normal">Normal</option>
            <option value="important">Important</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="updateSticky" />
          <label class="form-check-label" for="updateSticky">
            Pin this update to top
          </label>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="isEvent" />
          <label class="form-check-label" for="isEvent">
            This is an event/meeting
          </label>
        </div>
        <div class="mb-3" id="eventDateContainer" style="display: none">
          <label class="form-label">Event Date & Time</label>
          <input type="datetime-local" class="form-control" id="eventDate" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="saveUpdate()">
          Post Update
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  let addUpdateModal;

  document.addEventListener("DOMContentLoaded", function () {
    addUpdateModal = new bootstrap.Modal(
      document.getElementById("addUpdateModal")
    );
    loadTodos();
    loadUpdates();
    loadRecentForms();

    // Event checkbox handler
    document.getElementById("isEvent").addEventListener("change", function () {
      const eventContainer = document.getElementById("eventDateContainer");
      eventContainer.style.display = this.checked ? "block" : "none";
    });
  });

  // Margin Calculator Functions
  function calculateFromCost() {
    const cost = parseFloat(document.getElementById("costPrice").value) || 0;
    const margin =
      parseFloat(document.getElementById("desiredMargin").value) || 0;

    if (cost > 0 && margin > 0) {
      // Formula: Selling Price = Cost Price / (1 - Margin/100)
      const sellingPrice = cost / (1 - margin / 100);
      document.getElementById("sellingPrice").value = sellingPrice.toFixed(2);
    }
  }

  function calculateFromMargin() {
    const cost = parseFloat(document.getElementById("costPrice").value) || 0;
    const margin =
      parseFloat(document.getElementById("desiredMargin").value) || 0;

    if (cost > 0 && margin > 0 && margin < 100) {
      const sellingPrice = cost / (1 - margin / 100);
      document.getElementById("sellingPrice").value = sellingPrice.toFixed(2);
    }
  }

  // Todo List Functions
  async function loadTodos() {
    try {
      const response = await fetch("/api/todos");
      const todos = await response.json();

      const todoList = document.getElementById("todoList");
      todoList.innerHTML = "";

      todos.forEach((todo) => {
        const todoItem = document.createElement("div");
        todoItem.className = `todo-item ${todo.completed ? "completed" : ""}`;
        todoItem.innerHTML = `
          <input type="checkbox" ${todo.completed ? "checked" : ""} 
                 onchange="toggleTodo(${todo.id})">
          <span style="flex: 1">${todo.text}</span>
          <button class="btn btn-sm btn-danger" onclick="deleteTodo(${
            todo.id
          })">
              <i class="bi bi-trash"></i>
          </button>
        `;
        todoList.appendChild(todoItem);
      });
    } catch (error) {
      console.error("Error loading todos:", error);
    }
  }

  async function addTodo() {
    const input = document.getElementById("newTodoInput");
    const text = input.value.trim();

    if (text) {
      try {
        const response = await fetch("/api/todos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: text }),
        });

        if (response.ok) {
          loadTodos();
          input.value = "";
        }
      } catch (error) {
        console.error("Error adding todo:", error);
      }
    }
  }

  async function toggleTodo(id) {
    try {
      await fetch(`/api/todos/${id}/toggle`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });
      loadTodos();
    } catch (error) {
      console.error("Error toggling todo:", error);
    }
  }

  async function deleteTodo(id) {
    if (confirm("Delete this task?")) {
      try {
        await fetch(`/api/todos/${id}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
        });
        loadTodos();
      } catch (error) {
        console.error("Error deleting todo:", error);
      }
    }
  }

  // Company Updates Functions
  function showAddUpdateModal() {
    addUpdateModal.show();
  }

  async function saveUpdate() {
    const title = document.getElementById("updateTitle").value;
    const message = document.getElementById("updateMessage").value;
    const priority = document.getElementById("updatePriority").value;
    const sticky = document.getElementById("updateSticky").checked;
    const isEvent = document.getElementById("isEvent").checked;
    const eventDate = document.getElementById("eventDate").value;

    if (title && message) {
      try {
        const response = await fetch("/api/company-updates", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: title,
            message: message,
            priority: priority,
            sticky: sticky,
            is_event: isEvent,
            event_date: eventDate || null,
          }),
        });

        if (response.ok) {
          loadUpdates();
          addUpdateModal.hide();

          // Clear form
          document.getElementById("updateTitle").value = "";
          document.getElementById("updateMessage").value = "";
          document.getElementById("updatePriority").value = "normal";
          document.getElementById("updateSticky").checked = false;
          document.getElementById("isEvent").checked = false;
          document.getElementById("eventDate").value = "";
          document.getElementById("eventDateContainer").style.display = "none";
        }
      } catch (error) {
        console.error("Error saving update:", error);
      }
    }
  }

  async function loadUpdates() {
    try {
      const response = await fetch("/api/company-updates");
      const updates = await response.json();

      const updatesList = document.getElementById("updatesList");
      updatesList.innerHTML = "";

      updates.forEach((update) => {
        const updateItem = document.createElement("div");
        updateItem.className = "update-item";

        const badge =
          update.priority === "urgent"
            ? "danger"
            : update.priority === "important"
            ? "warning"
            : "secondary";

        const timeAgo = getTimeAgo(new Date(update.created_at));

        let eventInfo = "";
        if (update.is_event && update.event_date) {
          const eventDate = new Date(update.event_date);
          eventInfo = `<div class="text-info small"><i class="bi bi-calendar-event"></i> ${eventDate.toLocaleString()}</div>`;
        }

        updateItem.innerHTML = `
          <div class="d-flex justify-content-between">
              <strong>${update.title}</strong>
              <div>
                  ${
                    update.sticky
                      ? '<i class="bi bi-pin-angle-fill text-primary me-2"></i>'
                      : ""
                  }
                  ${
                    update.is_event
                      ? '<i class="bi bi-calendar-event text-info me-2"></i>'
                      : ""
                  }
                  <span class="badge bg-${badge}">${update.priority}</span>
                  <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteUpdate(${
                    update.id
                  })">
                    <i class="bi bi-trash"></i>
                  </button>
              </div>
          </div>
          <p class="mb-1">${update.message}</p>
          ${eventInfo}
          <div class="update-meta">Posted by ${
            update.author_name
          } • ${timeAgo}</div>
        `;

        updatesList.appendChild(updateItem);
      });
    } catch (error) {
      console.error("Error loading updates:", error);
    }
  }

  async function deleteUpdate(id) {
    if (confirm("Delete this update?")) {
      try {
        await fetch(`/api/company-updates/${id}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
        });
        loadUpdates();
      } catch (error) {
        console.error("Error deleting update:", error);
      }
    }
  }

  // Recent Forms Functions
  async function loadRecentForms() {
    try {
      const response = await fetch("/api/recent-forms");
      const forms = await response.json();

      const formsList = document.getElementById("recentFormsList");
      formsList.innerHTML = "";

      if (forms.length === 0) {
        formsList.innerHTML = '<p class="text-muted">No forms created yet.</p>';
        return;
      }

      forms.forEach((form) => {
        const formItem = document.createElement("div");
        formItem.className = "border-bottom pb-2 mb-2";

        const timeAgo = getTimeAgo(new Date(form.date_created));

        formItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${form.type}</strong><br>
              <p>${form.customer_name}<p>
              <small class="text-muted">by ${form.author} • ${timeAgo}</small>
            </div>
            <a href="/form/${form.id}" class="btn btn-sm btn-outline-primary">View</a>
          </div>
        `;
        formsList.appendChild(formItem);
      });
    } catch (error) {
      console.error("Error loading recent forms:", error);
    }
  }

  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";

    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";

    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";

    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";

    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";

    return "Just now";
  }
</script>
{% endblock %}
