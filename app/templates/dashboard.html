{% extends "base.html" %} {% block content %}

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Dashboard - Welcome, {{ current_user.username }}</h2>
    <span class="text-muted">{{ current_date }}</span>
  </div>

  <div class="dashboard-container">
    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Company Updates Section - Moved to Top -->
      <div class="card">
        <div class="card-header updates-card">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-megaphone-fill"></i> Company Updates & Events
            </h5>
            <button class="btn btn-sm btn-light" onclick="showAddUpdateModal()">
              <i class="bi bi-plus"></i> Add Update
            </button>
          </div>
        </div>
        <div class="card-body" style="max-height: 400px; overflow-y: auto">
          <div id="updatesList">
            <!-- Updates will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Recent Forms Section -->
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-file-text-fill"></i> Recent Forms
          </h5>
        </div>
        <div class="card-body">
          <div id="recentFormsList">
            <!-- Recent forms will be loaded here -->
          </div>
          <div class="text-center mt-3">
            <a
              href="{{ url_for('main.forms') }}"
              class="btn btn-outline-primary"
            >
              <i class="bi bi-folder-open"></i> View All Forms
            </a>
          </div>
        </div>
      </div>

      <!-- Call Sheets Section -->
      <div class="card">
        <div class="card-header callsheet-card">
          <h5 class="mb-0">
            <i class="bi bi-telephone-fill"></i> Call Sheet Management
          </h5>
        </div>
        <div class="card-body">
          <p>
            Manage your daily call sheets, track customer contacts, and record
            orders.
          </p>
          <div class="d-grid gap-2 d-md-block">
            <a
              href="{{ url_for('main.callsheets') }}"
              class="btn btn-lg action-button"
            >
              <i class="bi bi-journal-check"></i> Open Call Sheets
            </a>
            <button
              class="btn btn-outline-secondary"
              onclick="viewTodaysCallsheet()"
            >
              <i class="bi bi-calendar-day"></i> Today's Schedule
            </button>
          </div>
        </div>
      </div>

      <!-- Forms Section -->
      <div class="card">
        <div class="card-header forms-card">
          <h5 class="mb-0">
            <i class="bi bi-file-text-fill"></i> Forms & Documentation
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="d-grid">
                <a
                  href="{{ url_for('main.returns') }}"
                  class="btn action-button"
                >
                  <i class="bi bi-arrow-return-left"></i> Credit / Uplift Form
                </a>
                <small class="text-muted mt-1">Process customer returns</small>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="d-grid">
                <a
                  href="{{ url_for('main.branded_stock') }}"
                  class="btn action-button"
                >
                  <i class="bi bi-box-seam"></i> Customers Own Stock
                </a>
                <small class="text-muted mt-1">Track Customers Own Stock</small>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="d-grid">
                <a
                  href="{{ url_for('main.invoice_correction') }}"
                  class="btn action-button"
                >
                  <i class="bi bi-receipt"></i> Invoiced Goods, Delivery Only
                </a>
                <small class="text-muted mt-1"
                  >Record invoice discrepancies</small
                >
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="d-grid">
                <a
                  href="{{ url_for('main.special_order') }}"
                  class="btn action-button"
                >
                  <i class="bi bi-star"></i> Special Orders
                </a>
                <small class="text-muted mt-1">Request special items</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Margin Calculator -->
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0">
            <i class="bi bi-calculator"></i> Margin Calculator
          </h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Cost Price (£)</label>
            <input
              type="number"
              class="form-control"
              id="costPrice"
              step="0.01"
              placeholder="Enter cost price"
              onkeyup="calculateFromCost()"
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Desired Margin (%)</label>
            <input
              type="number"
              class="form-control"
              id="desiredMargin"
              step="0.1"
              placeholder="Enter desired margin"
              onkeyup="calculateFromMargin()"
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Selling Price (£)</label>
            <input
              type="number"
              class="form-control"
              id="sellingPrice"
              step="0.01"
              placeholder="Calculated selling price"
              readonly
              style="background-color: #f8f9fa"
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input
              type="number"
              class="form-control"
              id="quantity"
              value="1"
              min="1"
              onkeyup="updateTotals()"
            />
          </div>
          <div class="alert alert-info">
            <div class="d-flex justify-content-between">
              <span>Unit Profit:</span>
              <strong id="unitProfit">£0.00</strong>
            </div>
            <div class="d-flex justify-content-between">
              <span>Total Profit:</span>
              <strong id="totalProfit">£0.00</strong>
            </div>
            <div class="d-flex justify-content-between">
              <span>Total Value:</span>
              <strong id="totalValue">£0.00</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Todo List -->
      <div class="card">
        <div class="card-header bg-success text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="bi bi-check2-square"></i> My Todo List
            </h6>
            <button class="btn btn-sm btn-light" onclick="addTodo()">
              <i class="bi bi-plus"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="todoList">
            <!-- Todo items will be loaded here -->
          </div>
          <div class="input-group mt-3">
            <input
              type="text"
              class="form-control"
              id="newTodoInput"
              placeholder="Add new task..."
              onkeypress="if(event.key==='Enter') addTodo()"
            />
            <button class="btn btn-success" onclick="addTodo()">Add</button>
          </div>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="card">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Quick Links</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a
              href="{{ url_for('main.callsheets') }}"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="bi bi-telephone"></i> Call Sheets
            </a>
            <a href="/customers/import" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-upload"></i> Import Customers
            </a>
            <a
              href="{{ url_for('main.forms') }}"
              class="btn btn-outline-primary btn-sm"
            >
              <i class="bi bi-folder"></i> View All Forms
            </a>
            <button
              class="btn btn-outline-secondary btn-sm"
              onclick="window.print()"
            >
              <i class="bi bi-printer"></i> Print Page
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Update Modal -->
<div class="modal fade" id="addUpdateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Company Update</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input type="text" class="form-control" id="updateTitle" />
        </div>
        <div class="mb-3">
          <label class="form-label">Message</label>
          <textarea class="form-control" id="updateMessage" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Priority</label>
          <select class="form-select" id="updatePriority">
            <option value="normal">Normal</option>
            <option value="important">Important</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="updateSticky" />
          <label class="form-check-label" for="updateSticky">
            Pin this update to top
          </label>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="isEvent" />
          <label class="form-check-label" for="isEvent">
            This is an event/meeting
          </label>
        </div>
        <div class="mb-3" id="eventDateContainer" style="display: none">
          <label class="form-label">Event Date & Time</label>
          <input type="datetime-local" class="form-control" id="eventDate" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="saveUpdate()">
          Post Update
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  let addUpdateModal;

  document.addEventListener("DOMContentLoaded", function () {
    addUpdateModal = new bootstrap.Modal(
      document.getElementById("addUpdateModal")
    );
    loadTodos();
    loadUpdates();
    loadRecentForms();

    // Event checkbox handler
    document.getElementById("isEvent").addEventListener("change", function () {
      const eventContainer = document.getElementById("eventDateContainer");
      eventContainer.style.display = this.checked ? "block" : "none";
    });
  });

  // Margin Calculator Functions
  function calculateFromCost() {
    const cost = parseFloat(document.getElementById("costPrice").value) || 0;
    const margin =
      parseFloat(document.getElementById("desiredMargin").value) || 0;

    if (cost > 0 && margin > 0) {
      // Formula: Selling Price = Cost Price / (1 - Margin/100)
      const sellingPrice = cost / (1 - margin / 100);
      document.getElementById("sellingPrice").value = sellingPrice.toFixed(2);
    }
    updateTotals();
  }

  function calculateFromMargin() {
    const cost = parseFloat(document.getElementById("costPrice").value) || 0;
    const margin =
      parseFloat(document.getElementById("desiredMargin").value) || 0;

    if (cost > 0 && margin > 0 && margin < 100) {
      const sellingPrice = cost / (1 - margin / 100);
      document.getElementById("sellingPrice").value = sellingPrice.toFixed(2);
    }
    updateTotals();
  }

  function updateTotals() {
    const cost = parseFloat(document.getElementById("costPrice").value) || 0;
    const selling =
      parseFloat(document.getElementById("sellingPrice").value) || 0;
    const quantity = parseFloat(document.getElementById("quantity").value) || 1;

    if (cost > 0 && selling > 0) {
      const unitProfit = selling - cost;
      const totalProfit = unitProfit * quantity;
      const totalValue = selling * quantity;

      document.getElementById("unitProfit").textContent =
        "£" + unitProfit.toFixed(2);
      document.getElementById("totalProfit").textContent =
        "£" + totalProfit.toFixed(2);
      document.getElementById("totalValue").textContent =
        "£" + totalValue.toFixed(2);
    } else {
      document.getElementById("unitProfit").textContent = "£0.00";
      document.getElementById("totalProfit").textContent = "£0.00";
      document.getElementById("totalValue").textContent = "£0.00";
    }
  }

  // Todo List Functions
  async function loadTodos() {
    try {
      const response = await fetch("/api/todos");
      const todos = await response.json();

      const todoList = document.getElementById("todoList");
      todoList.innerHTML = "";

      todos.forEach((todo) => {
        const todoItem = document.createElement("div");
        todoItem.className = `todo-item ${todo.completed ? "completed" : ""}`;
        todoItem.innerHTML = `
          <input type="checkbox" ${todo.completed ? "checked" : ""} 
                 onchange="toggleTodo(${todo.id})">
          <span style="flex: 1">${todo.text}</span>
          <button class="btn btn-sm btn-danger" onclick="deleteTodo(${
            todo.id
          })">
              <i class="bi bi-trash"></i>
          </button>
        `;
        todoList.appendChild(todoItem);
      });
    } catch (error) {
      console.error("Error loading todos:", error);
    }
  }

  async function addTodo() {
    const input = document.getElementById("newTodoInput");
    const text = input.value.trim();

    if (text) {
      try {
        const response = await fetch("/api/todos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: text }),
        });

        if (response.ok) {
          loadTodos();
          input.value = "";
        }
      } catch (error) {
        console.error("Error adding todo:", error);
      }
    }
  }

  async function toggleTodo(id) {
    try {
      await fetch(`/api/todos/${id}/toggle`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });
      loadTodos();
    } catch (error) {
      console.error("Error toggling todo:", error);
    }
  }

  async function deleteTodo(id) {
    if (confirm("Delete this task?")) {
      try {
        await fetch(`/api/todos/${id}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
        });
        loadTodos();
      } catch (error) {
        console.error("Error deleting todo:", error);
      }
    }
  }

  // Company Updates Functions
  function showAddUpdateModal() {
    addUpdateModal.show();
  }

  async function saveUpdate() {
    const title = document.getElementById("updateTitle").value;
    const message = document.getElementById("updateMessage").value;
    const priority = document.getElementById("updatePriority").value;
    const sticky = document.getElementById("updateSticky").checked;
    const isEvent = document.getElementById("isEvent").checked;
    const eventDate = document.getElementById("eventDate").value;

    if (title && message) {
      try {
        const response = await fetch("/api/company-updates", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: title,
            message: message,
            priority: priority,
            sticky: sticky,
            is_event: isEvent,
            event_date: eventDate || null,
          }),
        });

        if (response.ok) {
          loadUpdates();
          addUpdateModal.hide();

          // Clear form
          document.getElementById("updateTitle").value = "";
          document.getElementById("updateMessage").value = "";
          document.getElementById("updatePriority").value = "normal";
          document.getElementById("updateSticky").checked = false;
          document.getElementById("isEvent").checked = false;
          document.getElementById("eventDate").value = "";
          document.getElementById("eventDateContainer").style.display = "none";
        }
      } catch (error) {
        console.error("Error saving update:", error);
      }
    }
  }

  async function loadUpdates() {
    try {
      const response = await fetch("/api/company-updates");
      const updates = await response.json();

      const updatesList = document.getElementById("updatesList");
      updatesList.innerHTML = "";

      updates.forEach((update) => {
        const updateItem = document.createElement("div");
        updateItem.className = "update-item";

        const badge =
          update.priority === "urgent"
            ? "danger"
            : update.priority === "important"
            ? "warning"
            : "secondary";

        const timeAgo = getTimeAgo(new Date(update.created_at));

        let eventInfo = "";
        if (update.is_event && update.event_date) {
          const eventDate = new Date(update.event_date);
          eventInfo = `<div class="text-info small"><i class="bi bi-calendar-event"></i> ${eventDate.toLocaleString()}</div>`;
        }

        updateItem.innerHTML = `
          <div class="d-flex justify-content-between">
              <strong>${update.title}</strong>
              <div>
                  ${
                    update.sticky
                      ? '<i class="bi bi-pin-angle-fill text-primary me-2"></i>'
                      : ""
                  }
                  ${
                    update.is_event
                      ? '<i class="bi bi-calendar-event text-info me-2"></i>'
                      : ""
                  }
                  <span class="badge bg-${badge}">${update.priority}</span>
                  <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteUpdate(${
                    update.id
                  })">
                    <i class="bi bi-trash"></i>
                  </button>
              </div>
          </div>
          <p class="mb-1">${update.message}</p>
          ${eventInfo}
          <div class="update-meta">Posted by ${
            update.author_name
          } • ${timeAgo}</div>
        `;

        updatesList.appendChild(updateItem);
      });
    } catch (error) {
      console.error("Error loading updates:", error);
    }
  }

  async function deleteUpdate(id) {
    if (confirm("Delete this update?")) {
      try {
        await fetch(`/api/company-updates/${id}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
        });
        loadUpdates();
      } catch (error) {
        console.error("Error deleting update:", error);
      }
    }
  }

  // Recent Forms Functions
  async function loadRecentForms() {
    try {
      const response = await fetch("/api/recent-forms");
      const forms = await response.json();

      const formsList = document.getElementById("recentFormsList");
      formsList.innerHTML = "";

      if (forms.length === 0) {
        formsList.innerHTML = '<p class="text-muted">No forms created yet.</p>';
        return;
      }

      forms.forEach((form) => {
        const formItem = document.createElement("div");
        formItem.className = "border-bottom pb-2 mb-2";

        const timeAgo = getTimeAgo(new Date(form.date_created));

        formItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>${form.type}</strong><br>
              <small class="text-muted">by ${form.author} • ${timeAgo}</small>
            </div>
            <a href="/form/${form.id}" class="btn btn-sm btn-outline-primary">View</a>
          </div>
        `;
        formsList.appendChild(formItem);
      });
    } catch (error) {
      console.error("Error loading recent forms:", error);
    }
  }

  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";

    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";

    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";

    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";

    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";

    return "Just now";
  }

  function viewTodaysCallsheet() {
    const today = new Date().toLocaleLowerCase();
    const days = [
      "sunday",
      "monday",
      "tuesday",
      "wednesday",
      "thursday",
      "friday",
      "saturday",
    ];
    const currentDay = days[new Date().getDay()];

    if (currentDay === "saturday" || currentDay === "sunday") {
      alert("No callsheets scheduled for weekends");
    } else {
      window.location.href = "/callsheets#" + currentDay;
    }
  }
</script>
{% endblock %}
