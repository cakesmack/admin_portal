{% extends "base.html" %} 
{% block content %}
<h2>Customer Stock Order Form</h2>
<p class="text-muted">Process customer orders from their held inventory</p>

<!-- Available Stock Items Table -->
<div class="card mb-4">
  <div class="card-header">
    <h5>Available Customer Stock</h5>
  </div>
  <div class="card-body">
    {% if stock_items and stock_items|length > 0 %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Customer</th>
            <th>Product Code</th>
            <th>Product Name</th>
            <th>Available Stock</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in stock_items %}
          <tr>
            <td>{{ item.customer.name }}</td>
            <td>{{ item.product_code or 'N/A' }}</td>
            <td>{{ item.product_name }}</td>
            <td>
              <span class="badge {% if item.current_stock == 0 %}bg-danger{% elif item.current_stock <= item.reorder_level %}bg-warning{% else %}bg-success{% endif %}">
                {{ item.current_stock }} {{ item.unit_type }}
              </span>
            </td>
            <td>
              <button 
                class="btn btn-sm btn-primary" 
                onclick="quickSelectItem({{ item.id }}, {{ item.customer_id }}, '{{ item.customer.account_number }}', '{{ item.customer.name }}', '{{ item.product_code or 'N/A' }}', '{{ item.product_name }}', {{ item.current_stock }}, '{{ item.unit_type }}')"
                {% if item.current_stock == 0 %}disabled{% endif %}>
                <i class="bi bi-cart-plus"></i> Create Order
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted">No customer stock items found. Add stock items in the Customer Stock page first.</p>
    {% endif %}
  </div>
</div>

<!-- Order Form Modal -->
<div class="modal fade" id="orderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Stock Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" id="orderForm">
          {{ form.hidden_tag() }}
          
          <input type="hidden" name="stock_item_id" id="modalStockItemId" />
          <input type="hidden" name="customer_id" id="modalCustomerId" />
          <input type="hidden" name="customer_account" id="modalCustomerAccount" />
          <input type="hidden" name="customer_name" id="modalCustomerName" />
          <input type="hidden" name="product_code" id="modalProductCode" />
          <input type="hidden" name="product_name" id="modalProductName" />

          <div class="alert alert-info">
            <strong>Customer:</strong> <span id="modalCustomerDisplay"></span><br>
            <strong>Product:</strong> <span id="modalProductDisplay"></span><br>
            <strong>Available Stock:</strong> <span id="modalAvailableStock"></span>
          </div>

          <!-- Address selection area -->
          <div class="address-selection-area-modal col-md-12 mb-3"></div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Quantity to Order *</label>
              <input
                type="number"
                class="form-control"
                name="quantity_delivered"
                id="modalQuantity"
                min="1"
                required
              />
              <small class="text-muted">Maximum: <span id="modalMaxQty"></span></small>
            </div>
            <div class="col-md-6">
              <label class="form-label">New Stock Level</label>
              <input
                type="number"
                class="form-control"
                name="current_stock"
                id="modalNewStock"
                readonly
                style="background-color: #f8f9fa"
              />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Order Reference</label>
            <input
              type="text"
              class="form-control"
              name="order_reference"
              id="modalReference"
              placeholder="Order number, invoice etc."
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Order Notes</label>
            <textarea
              class="form-control"
              name="order_notes"
              id="modalNotes"
              rows="3"
              placeholder="Additional notes about this order"
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitOrder()">
          <i class="bi bi-check-circle"></i> Process Order
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Recent Stock Orders -->
<div class="card mt-4">
  <div class="card-header">
    <h5>Recent Stock Orders</h5>
  </div>
  <div class="card-body">
    {% if recent_branded_stock and recent_branded_stock|length > 0 %}
    <div class="table-responsive">
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer</th>
            <th>Product</th>
            <th>Qty Ordered</th>
            <th>New Stock Level</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for delivery in recent_branded_stock %}
          <tr>
            <td>{{ delivery.date_created.strftime('%Y-%m-%d %H:%M') if delivery.date_created else 'N/A' }}</td>
            <td>{{ delivery.data.get('customer_name', delivery.data.get('customer_account', 'N/A')) }}</td>
            <td>{{ delivery.data.get('product_name', delivery.data.get('product_code', 'N/A')) }}</td>
            <td>{{ delivery.data.get('quantity_delivered', 'N/A') }}</td>
            <td>{{ delivery.data.get('current_stock', 'N/A') }}</td>
            <td>
              <a
                href="{{ url_for('main.print_form', form_id=delivery.id) }}"
                class="btn btn-sm btn-primary"
                target="_blank"
              >
                <i class="bi bi-printer"></i> Print
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted">No stock orders recorded yet.</p>
    {% endif %}
  </div>
</div>

{% endblock %} 

{% block scripts %}
<script type="module">
  import {
    setupAddressSelector,
    getSelectedAddress,
  } from "/static/js/script.js";

  let selectedStockItem = null;
  let selectedCustomerForAddress = null;
  let orderModal;

  document.addEventListener("DOMContentLoaded", function () {
    orderModal = new bootstrap.Modal(document.getElementById("orderModal"));
    
    // Setup quantity calculation in modal
    document.getElementById("modalQuantity").addEventListener("input", calculateModalNewStock);
  });

  // Quick select function from stock table
  window.quickSelectItem = async function(itemId, customerId, accountNumber, customerName, productCode, productName, currentStock, unitType) {
    // Set selected stock item
    selectedStockItem = {
      id: itemId,
      customerId: customerId,
      account_number: accountNumber,
      customer_name: customerName,
      product_code: productCode,
      product_name: productName,
      current_stock: currentStock,
      unit_type: unitType
    };
    
    // Fill modal hidden fields
    document.getElementById("modalStockItemId").value = itemId;
    document.getElementById("modalCustomerId").value = customerId;
    document.getElementById("modalCustomerAccount").value = accountNumber;
    document.getElementById("modalCustomerName").value = customerName;
    document.getElementById("modalProductCode").value = productCode;
    document.getElementById("modalProductName").value = productName;
    
    // Update modal display
    document.getElementById("modalCustomerDisplay").textContent = `${accountNumber} - ${customerName}`;
    document.getElementById("modalProductDisplay").textContent = `${productCode} - ${productName}`;
    document.getElementById("modalAvailableStock").textContent = `${currentStock} ${unitType}`;
    document.getElementById("modalMaxQty").textContent = `${currentStock} ${unitType}`;
    
    // Set max quantity
    document.getElementById("modalQuantity").max = currentStock;
    document.getElementById("modalQuantity").value = "";
    document.getElementById("modalNewStock").value = currentStock;
    
    // Clear other fields
    document.getElementById("modalReference").value = "";
    document.getElementById("modalNotes").value = "";
    
    // Setup address selector for this customer
    try {
      const response = await fetch(`/api/customers/search?q=${accountNumber}`);
      const customers = await response.json();
      
      if (customers.length > 0) {
        selectedCustomerForAddress = customers[0];
        const addressContainer = document.querySelector(".address-selection-area-modal");
        
        // Clear previous address selector
        addressContainer.innerHTML = "";
        
        // Setup address selection
        await setupAddressSelector(selectedCustomerForAddress, addressContainer, (address, label) => {
          // Address is selected, we'll get it on submit
        });
      }
    } catch (error) {
      console.error("Error loading customer for address:", error);
    }
    
    // Show modal
    orderModal.show();
  }
  
  function calculateModalNewStock() {
    const ordered = parseInt(document.getElementById("modalQuantity").value) || 0;
    const available = selectedStockItem ? selectedStockItem.current_stock : 0;
    const newLevel = Math.max(0, available - ordered);
    
    document.getElementById("modalNewStock").value = newLevel;
    
    // Visual feedback
    const input = document.getElementById("modalQuantity");
    if (ordered > available) {
      input.style.borderColor = "#dc3545";
    } else if (ordered > 0) {
      input.style.borderColor = "#28a745";
    } else {
      input.style.borderColor = "";
    }
  }
  
  window.submitOrder = function() {
    const quantity = parseInt(document.getElementById("modalQuantity").value);
    const available = selectedStockItem ? selectedStockItem.current_stock : 0;
    
    if (!quantity || quantity < 1) {
      alert("Please enter a valid quantity");
      return;
    }
    
    if (quantity > available) {
      alert(`Cannot order more than available stock (${available})`);
      return;
    }
    
    // Show loading state
    const submitBtn = event.target;
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
    
    // Get selected address
    const addressContainer = document.querySelector(".address-selection-area-modal");
    const selectedAddressData = addressContainer ? getSelectedAddress(addressContainer) : null;

    // Add address label to form if available
    let addressLabel = "";
    if (selectedAddressData && selectedAddressData.label) {
      addressLabel = selectedAddressData.label;
    }

    // Get form data
    const formData = new FormData(document.getElementById("orderForm"));
    if (addressLabel) {
      formData.append("address_label", addressLabel);
    }
    
    // Submit via fetch
    fetch('{{ url_for("main.branded_stock") }}', {
      method: 'POST',
      body: formData
    })
    .then(response => response.text())
    .then(html => {
      // Check if response contains the script tag with print window
      if (html.includes('window.open')) {
        // Extract the URL from the script
        const match = html.match(/window\.open\('([^']+)'/);
        if (match && match[1]) {
          // Open print window
          window.open(match[1], '_blank');
          
          // Close modal and reload page
          orderModal.hide();
          window.location.reload();
        }
      } else {
        // Something went wrong, reload to show error message
        window.location.reload();
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error processing order');
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    });
  }
</script>

{% endblock %}