{% extends "base.html" %}
{% block content %}
<h2>Customer Stock Order Form</h2>
<p class="text-muted">Process customer orders from their held inventory</p>

<!-- Available Stock Items Table -->
<div class="card mb-4">
  <div class="card-header">
    <h5>Available Customer Stock</h5>
  </div>
  <div class="card-body">
    {% if stock_items and stock_items|length > 0 %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Customer</th>
            <th>Product Code</th>
            <th>Product Name</th>
            <th>Available Stock</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in stock_items %}
          <tr>
            <td>{{ item.customer.name }}</td>
            <td>{{ item.product_code or 'N/A' }}</td>
            <td>{{ item.product_name }}</td>
            <td>
              <span class="badge {% if item.current_stock == 0 %}bg-danger{% elif item.current_stock <= item.reorder_level %}bg-warning{% else %}bg-success{% endif %}">
                {{ item.current_stock }} {{ item.unit_type }}
              </span>
            </td>
            <td>
              <button 
                class="btn btn-sm btn-primary" 
                onclick="quickSelectItem({{ item.id }}, {{ item.customer_id }}, '{{ item.customer.account_number }}', '{{ item.customer.name }}', '{{ item.product_code or 'N/A' }}', '{{ item.product_name }}', {{ item.current_stock }}, '{{ item.unit_type }}')"
                {% if item.current_stock == 0 %}disabled{% endif %}>
                <i class="bi bi-cart-plus"></i> Create Order
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted">No customer stock items found. Add stock items in the Customer Stock page first.</p>
    {% endif %}
  </div>
</div>

<!-- Order Form Modal -->
<div class="modal fade" id="orderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Stock Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{{ url_for('customer_stock.branded_stock') }}" id="orderForm">
          {{ form.hidden_tag() }}
          
          <input type="hidden" name="stock_item_id" id="modalStockItemId">
          <input type="hidden" name="customer_id" id="modalCustomerId">
          <input type="hidden" name="customer_account" id="modalCustomerAccount">
          <input type="hidden" name="customer_name" id="modalCustomerName">
          <input type="hidden" name="product_code" id="modalProductCode">
          <input type="hidden" name="product_name" id="modalProductName">
          <input type="hidden" name="address_label" id="address_label">

          <div class="alert alert-info">
            <strong>Customer:</strong> <span id="modalCustomerDisplay"></span><br>
            <strong>Product:</strong> <span id="modalProductDisplay"></span><br>
            <strong>Available Stock:</strong> <span id="modalAvailableStock"></span>
          </div>

          <!-- Address selection area - populated dynamically -->
          <div class="address-selection-area-modal col-md-12 mb-3"></div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Quantity to Order *</label>
              <input type="number" class="form-control" name="quantity_delivered" id="modalQuantity" min="1" required>
              <small class="text-muted">Maximum: <span id="modalMaxQty"></span></small>
            </div>
            <div class="col-md-6">
              <label class="form-label">New Stock Level</label>
              <input type="number" class="form-control" name="current_stock" id="modalNewStock" readonly style="background-color: #f8f9fa">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Order Reference</label>
            <input type="text" class="form-control" name="order_reference" id="modalReference" placeholder="Order number, invoice etc.">
          </div>

          <div class="mb-3">
            <label class="form-label">Order Notes</label>
            <textarea class="form-control" name="order_notes" id="modalNotes" rows="3" placeholder="Additional notes about this order"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitOrder()">
          <i class="bi bi-check-circle"></i> Process Order
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Recent Stock Orders -->
<div class="card mt-4">
  <div class="card-header">
    <h5>Recent Stock Orders</h5>
  </div>
  <div class="card-body">
    {% if recent_branded_stock and recent_branded_stock|length > 0 %}
    <div class="table-responsive">
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer</th>
            <th>Product</th>
            <th>Qty Ordered</th>
            <th>New Stock Level</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for delivery in recent_branded_stock %}
          <tr>
            <td>{{ delivery.date_created.strftime('%Y-%m-%d %H:%M') if delivery.date_created else 'N/A' }}</td>
            <td>{{ delivery.data.get('customer_name', delivery.data.get('customer_account', 'N/A')) }}</td>
            <td>{{ delivery.data.get('product_name', delivery.data.get('product_code', 'N/A')) }}</td>
            <td>{{ delivery.data.get('quantity_delivered', 'N/A') }}</td>
            <td>{{ delivery.data.get('current_stock', 'N/A') }}</td>
            <td>
              <a href="{{ url_for('forms.print_form', form_id=delivery.id) }}" class="btn btn-sm btn-primary" target="_blank">
                <i class="bi bi-printer"></i> Print
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted">No recent orders</p>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // NO IMPORTS - Plain JavaScript only
  let orderModal;

  document.addEventListener("DOMContentLoaded", function () {
    orderModal = new bootstrap.Modal(document.getElementById('orderModal'));

    // Auto-calculate new stock level when quantity changes
    const quantityInput = document.getElementById('modalQuantity');
    quantityInput.addEventListener('input', function() {
      const availableStock = parseInt(this.getAttribute('data-available')) || 0;
      const ordered = parseInt(this.value) || 0;
      const newStock = availableStock - ordered;
      document.getElementById('modalNewStock').value = newStock;
    });
  });

  // Quick select item from table
  function quickSelectItem(stockItemId, customerId, customerAccount, customerName, productCode, productName, availableStock, unitType) {
    // Store data in hidden fields
    document.getElementById('modalStockItemId').value = stockItemId;
    document.getElementById('modalCustomerId').value = customerId;
    document.getElementById('modalCustomerAccount').value = customerAccount;
    document.getElementById('modalCustomerName').value = customerName;
    document.getElementById('modalProductCode').value = productCode;
    document.getElementById('modalProductName').value = productName;

    // Display info
    document.getElementById('modalCustomerDisplay').textContent = customerAccount + ' - ' + customerName;
    document.getElementById('modalProductDisplay').textContent = productCode + ' - ' + productName;
    document.getElementById('modalAvailableStock').textContent = availableStock + ' ' + unitType;
    document.getElementById('modalMaxQty').textContent = availableStock;

    // Setup quantity input
    const quantityInput = document.getElementById('modalQuantity');
    quantityInput.max = availableStock;
    quantityInput.value = 1;
    quantityInput.setAttribute('data-available', availableStock);

    // Calculate initial new stock
    document.getElementById('modalNewStock').value = availableStock - 1;

    // Fetch customer addresses and setup address selector
    fetchCustomerAddresses(customerId);

    // Show modal
    orderModal.show();
  }

  // Fetch customer addresses
  async function fetchCustomerAddresses(customerId) {
    try {
      const response = await fetch('/api/customer/' + customerId + '/addresses');
      const addresses = await response.json();

      const container = document.querySelector('.address-selection-area-modal');
      
      if (addresses.length === 0) {
        container.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> This customer has no address on file. Please add one.</div>';
      } else if (addresses.length === 1) {
        const addr = addresses[0];
        container.innerHTML = '<div class="alert alert-info"><strong>Delivery Address:</strong> ' + addr.label + '<br>' + formatAddress(addr) + '</div>';
        document.getElementById('address_label').value = addr.label;
      } else {
        // Show address selector
        showAddressSelector(addresses, container);
      }
    } catch (error) {
      console.error('Error fetching addresses:', error);
    }
  }

  // Show address selector
  function showAddressSelector(addresses, container) {
    let html = '<div class="mb-3"><label class="form-label"><strong>Select Delivery Location:</strong></label>';
    html += '<select class="form-select address-location-select" required>';
    html += '<option value="">Choose location...</option>';
    
    addresses.forEach((addr, idx) => {
      html += '<option value="' + idx + '" data-label="' + addr.label + '">';
      html += addr.label;
      if (addr.street) html += ' - ' + addr.street;
      html += '</option>';
    });
    
    html += '</select>';
    html += '<div class="selected-address-display mt-2" style="display: none;"></div>';
    html += '</div>';

    container.innerHTML = html;

    const select = container.querySelector(".address-location-select");
    const displayDiv = container.querySelector(".selected-address-display");

    select.addEventListener("change", function () {
      const idx = parseInt(this.value);
      
      if (!isNaN(idx) && addresses[idx]) {
        const selectedAddress = addresses[idx];
        
        displayDiv.innerHTML = '<div class="alert alert-success"><strong>' + selectedAddress.label + '</strong><br>' + formatAddress(selectedAddress) + '</div>';
        displayDiv.style.display = "block";

        // Store address label
        document.getElementById('address_label').value = selectedAddress.label;
      } else {
        displayDiv.style.display = "none";
        document.getElementById('address_label').value = "";
      }
    });
  }

  // Format address for display
  function formatAddress(address) {
    const parts = [];
    if (address.street) parts.push(address.street);
    if (address.city) parts.push(address.city);
    if (address.zip) parts.push(address.zip);
    return parts.length > 0 ? parts.join(", ") : "Address not specified";
  }

  // Submit order
  function submitOrder() {
    const form = document.getElementById('orderForm');
    const quantity = parseInt(document.getElementById('modalQuantity').value);
    const maxQty = parseInt(document.getElementById('modalQuantity').max);

    // Validate
    if (!quantity || quantity < 1) {
      alert('Please enter a valid quantity');
      return;
    }

    if (quantity > maxQty) {
      alert('Cannot order more than ' + maxQty + ' units');
      return;
    }

    // Submit form normally (not via AJAX)
    form.submit();
  }
</script>
{% endblock %}