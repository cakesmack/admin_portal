{% extends "base.html" %}
{% block content %}

<!-- Include Select2 for autocomplete -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.css" rel="stylesheet" />

<style>
/* CALLSHEET ROW COLORS - MAXIMUM SPECIFICITY TO OVERRIDE DARK THEME */

/* GREEN - Customer placed an order */
table.table tbody tr.callsheet-row.status-ordered,
table.table tbody tr.callsheet-row.status-ordered td {
    background-color: #d1e7dd !important;
    color: #0f5132 !important;
}

/* RED - Customer declined or no answer */
table.table tbody tr.callsheet-row.status-no_answer,
table.table tbody tr.callsheet-row.status-no_answer td,
table.table tbody tr.callsheet-row.status-declined,
table.table tbody tr.callsheet-row.status-declined td {
    background-color: #f8d7da !important;
    color: #842029 !important;
}

/* BLUE - Callback scheduled */
table.table tbody tr.callsheet-row.status-callback,
table.table tbody tr.callsheet-row.status-callback td {
    background-color: #fff3cd !important;
    color: #856404 !important;
}

/* WHITE - Not yet called */
table.table tbody tr.callsheet-row.status-not_called,
table.table tbody tr.callsheet-row.status-not_called td {
    background-color: white !important;
    color: #212529 !important;
}

/* GRAY - Paused customers */
table.table tbody tr.callsheet-row.paused-customer,
table.table tbody tr.callsheet-row.paused-customer td {
    background-color: #e9ecef !important;
    color: #6c757d !important;
    opacity: 0.7;
}

table.table tbody tr.callsheet-row.paused-customer td {
    font-style: italic;
}

/* Keep text readable in all states */
table.table tbody tr.callsheet-row td strong,
table.table tbody tr.callsheet-row td small {
    color: inherit !important;
}

/* Hover effect */
table.table tbody tr.callsheet-row:hover td {
    filter: brightness(0.95);
}

.notes-preview {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.85rem;
}

.notes-has-content {
    color: #0d6efd;
    font-weight: 500;
}

.callsheet-header {
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.drag-handle {
    cursor: move;
    color: #adb5bd;
}

.drag-handle:hover {
    color: #495057;
}

.sortable-ghost {
    opacity: 0.4;
    background: #f8f9fa;
}

.status-select {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

.action-buttons {
    white-space: nowrap;
}

.month-nav {
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* Loading spinner */
.spinner-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.spinner-overlay.show {
    display: flex;
}

/* Toast notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .callsheet-row {
        font-size: 0.85rem;
    }
    
    .table-responsive {
        font-size: 0.85rem;
    }
}
</style>

<div class="container-fluid">
    <!-- Header with month navigation -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="month-nav">
            <a href="?month={{ prev_month }}&year={{ prev_year }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-chevron-left"></i> Previous
            </a>
            <h2 class="mb-0">Call Sheets - {{ month_name }} {{ current_year }}</h2>
            <a href="?month={{ next_month }}&year={{ next_year }}" class="btn btn-outline-secondary btn-sm">
                Next <i class="bi bi-chevron-right"></i>
            </a>
        </div>
        <div>
            <button class="btn btn-warning me-2" onclick="resetWeek()" title="Reset all callsheets to 'Not Called' status">
                <i class="bi bi-arrow-clockwise"></i> Reset Week
            </button>
            <button class="btn btn-secondary me-2" onclick="archiveMonth()">
                <i class="bi bi-archive"></i> Archive Month
            </button>
           
            <button class="btn btn-success" onclick="showAddCallsheetModal()">
                <i class="bi bi-plus-circle"></i> Add Callsheet
            </button>
        </div>
    </div>

    <!-- Days of Week Tabs -->
    <ul class="nav nav-tabs" id="dayTabs" role="tablist">
        {% for day in days_of_week %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}" 
                    id="{{ day }}-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#{{ day }}" 
                    type="button">
                {{ day }}
                {% if callsheets_by_day[day] %}
                    <span class="badge bg-primary ms-1">{{ callsheets_by_day[day]|length }}</span>
                {% endif %}
            </button>
        </li>
        {% endfor %}
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mt-3" id="dayTabContent">
        {% for day in days_of_week %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ day }}">
            
            {% if callsheets_by_day[day] %}
            <!-- Callsheet tabs for this day -->
            <ul class="nav nav-pills mb-3">
                {% for callsheet in callsheets_by_day[day] %}
                <li class="nav-item me-2">
                    <a class="nav-link {% if loop.first %}active{% endif %}" 
                       data-bs-toggle="pill" 
                       href="#callsheet-{{ callsheet.id }}">
                        {{ callsheet.name }}
                        <span class="ms-2">
                            <i class="bi bi-pencil-square text-white" 
                               onclick="editCallsheet(event, {{ callsheet.id }}, '{{ callsheet.name }}', '{{ day }}')"
                               title="Edit"
                               style="cursor: pointer;"></i>
                            <i class="bi bi-trash text-white ms-1" 
                               onclick="deleteCallsheet(event, {{ callsheet.id }})"
                               title="Delete"
                               style="cursor: pointer;"></i>
                        </span>
                    </a>
                </li>
                {% endfor %}
            </ul>
            
            <!-- Callsheet content -->
            <div class="tab-content">
                {% for callsheet in callsheets_by_day[day] %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                     id="callsheet-{{ callsheet.id }}">
                    
                    <div class="card">
                        <div class="card-header callsheet-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ callsheet.name }} - {{ day }}</h5>
                            <button class="btn btn-sm btn-primary" 
                                    onclick="showAddCustomerModal({{ callsheet.id }})">
                                <i class="bi bi-person-plus"></i> Add Customer
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="callsheet-table-{{ callsheet.id }}">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 20px;"></th>
                                            <th style="width: 120px;">Account</th>
                                            <th style="width: 80px;">Status</th>
                                            <th style="width: 80px;">Called By</th>
                                            <th style="width: 80px;">Person/Time</th>
                                            <th style="width: 350px;">Notes</th>
                                            <th style="width: 80px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="sortable-list" data-callsheet-id="{{ callsheet.id }}">
                                        {% for entry in callsheet.entries %}
                                        <tr class="callsheet-row status-{{ entry.call_status }}" 
                                            data-entry-id="{{ entry.id }}">
                                            <td class="text-center">
                                                <i class="bi bi-grip-vertical drag-handle"></i>
                                            </td>
                                            <td><strong>{{ entry.customer.name }}<br />
                                            {{ entry.customer.account_number }}</strong></td>
                                            <td>
                                                <select class="form-select form-select-sm status-select" 
                                                        onchange="confirmStatusChange(this, {{ entry.id }})"
                                                        data-current-status="{{ entry.call_status }}">
                                                    <option value="not_called" {% if entry.call_status == 'not_called' %}selected{% endif %}>Not Called</option>
                                                    <option value="no_answer" {% if entry.call_status == 'no_answer' %}selected{% endif %}>No Answer</option>
                                                    <option value="declined" {% if entry.call_status == 'declined' %}selected{% endif %}>Declined</option>
                                                    <option value="ordered" {% if entry.call_status == 'ordered' %}selected{% endif %}>Ordered</option>
                                                    <option value="callback" {% if entry.call_status == 'callback' %}selected{% endif %}>Callback</option>
                                                </select>
                                            </td>
                                            <td><small>{{ entry.called_by or '-' }}</small></td>
                                            <td>
                                                <small>{{ entry.person_spoken_to or '-' }}</small>
                                                {% if entry.callback_time %}
                                                    <br><span class="badge bg-info">{{ entry.callback_time }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="notes-preview {% if entry.customer.callsheet_notes %}notes-has-content{% endif %}" 
                                                         onclick="showNotesModal({{ entry.id }}, {{ entry.customer.id }}, `{{ entry.customer.callsheet_notes|e|replace('\n', '\\n')|replace('`', '\\`') }}`)">
                                                        {% if entry.customer.callsheet_notes %}
                                                            {{ entry.customer.callsheet_notes[:50] }}{% if entry.customer.callsheet_notes|length > 50 %}...{% endif %}
                                                        {% else %}
                                                            <span class="text-muted">Click to add notes</span>
                                                        {% endif %}
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-secondary ms-2" 
                                                            onclick="showNotesModal({{ entry.id }}, {{ entry.customer.id }}, `{{ entry.customer.callsheet_notes|e|replace('\n', '\\n')|replace('`', '\\`') }}`)">
                                                        <i class="bi bi-chat-dots{% if entry.customer.callsheet_notes %}-fill{% endif %}"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="action-buttons">
                                                <button class="btn btn-sm btn-warning" 
                                                        onclick="togglePauseCustomer({{ entry.id }})"
                                                        title="Pause customer (seasonal)">
                                                    <i class="bi bi-pause-circle"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" 
                                                        onclick="removeCustomer({{ entry.id }})"
                                                        title="Remove from callsheet">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        
                                        {% if callsheet.paused_entries %}
                                        <!-- Paused Customers Section -->
                                        <tr class="table-secondary">
                                            <td colspan="7" class="text-center py-2">
                                                <strong><i class="bi bi-pause-circle"></i> Paused Customers (Seasonal)</strong>
                                            </td>
                                        </tr>
                                        {% for entry in callsheet.paused_entries %}
                                        <tr class="callsheet-row paused-customer" 
                                            data-entry-id="{{ entry.id }}">
                                            <td class="text-center">
                                                <i class="bi bi-grip-vertical drag-handle"></i>
                                            </td>
                                            <td><strong>{{ entry.customer.name }}<br />
                                            {{ entry.customer.account_number }}</strong></td>
                                            <td colspan="4">
                                                <span class="badge bg-secondary">Paused</span>
                                                <small class="text-muted ms-2">This customer is temporarily inactive</small>
                                            </td>
                                            <td class="action-buttons">
                                                <button class="btn btn-sm btn-success" 
                                                        onclick="togglePauseCustomer({{ entry.id }})"
                                                        title="Resume customer">
                                                    <i class="bi bi-play-circle"></i> Resume
                                                </button>
                                                <button class="btn btn-sm btn-danger" 
                                                        onclick="removeCustomer({{ entry.id }})"
                                                        title="Remove from callsheet">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-info-circle me-2"></i>
                    No callsheets for {{ day }}. Create one to get started!
                </div>
                <button class="btn btn-sm btn-primary" 
                        onclick="showAddCallsheetModal('{{ day }}')">
                    Add Callsheet
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Loading Spinner -->
<div class="spinner-overlay" id="loadingSpinner">
    <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Add/Edit Callsheet Modal -->
<div class="modal fade" id="callsheetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="callsheetModalTitle">Add New Callsheet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="callsheetForm">
                    <input type="hidden" id="callsheetId">
                    <div class="mb-3">
                        <label class="form-label">Callsheet Name</label>
                        <input type="text" class="form-control" id="callsheetName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Day of Week</label>
                        <select class="form-select" id="callsheetDay" required>
                            {% for day in days_of_week %}
                            <option value="{{ day }}">{{ day }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCallsheet()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalTitle">Update Call Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="statusEntryId">
                <input type="hidden" id="statusValue">
                
                <!-- Always show person spoken to (for all statuses) -->
                <div class="mb-3">
                    <label class="form-label">Person Spoken To (Optional)</label>
                    <input type="text" class="form-control" id="personSpokenTo" 
                           placeholder="Name of person you spoke with">
                    <small class="text-muted">Record who you spoke to for any status</small>
                </div>
                
                <!-- Show for callback status -->
                <div id="callbackDetails" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label">Callback Time</label>
                        <input type="text" class="form-control" id="callbackTime" 
                               placeholder="e.g., Tomorrow 2PM, Monday morning">
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <small><i class="bi bi-info-circle"></i> Use the Notes section below to add any additional details about this call.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCallStatus()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Notes Modal -->
<div class="modal fade" id="notesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customer Notes (Persistent)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="notesEntryId">
                <input type="hidden" id="notesCustomerId">
                <div class="alert alert-info">
                    <i class="bi bi-lightbulb"></i> These notes are saved to the customer and will persist across all callsheets. Delete when no longer needed.
                </div>
                <textarea class="form-control" id="notesText" rows="6" 
                          placeholder="Enter notes about this customer..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="clearNotes()">
                    <i class="bi bi-trash"></i> Clear Notes
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Customer to Callsheet Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Customer to Callsheet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="addCallsheetId">
                <div class="mb-3">
                    <label class="form-label">Search Customer (by account number or name)</label>
                    <select class="form-control" id="customerSearchSelect" style="width: 100%;">
                        <option></option>
                    </select>
                </div>
                <div id="selectedCustomerInfo" class="alert alert-info" style="display:none;">
                    <strong>Selected Customer:</strong><br>
                    <span id="selectedCustomerDetails"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addCustomerToCallsheet()">Add Customer</button>
            </div>
        </div>
    </div>
</div>


<!-- Include jQuery, Select2, and SortableJS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Initialize modals
let callsheetModal, statusModal, notesModal, addCustomerModal, manageCustomersModal;
let selectedCustomerId = null;

document.addEventListener('DOMContentLoaded', function() {
    callsheetModal = new bootstrap.Modal(document.getElementById('callsheetModal'));
    statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    notesModal = new bootstrap.Modal(document.getElementById('notesModal'));
    addCustomerModal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
    manageCustomersModal = new bootstrap.Modal(document.getElementById('manageCustomersModal'));
    
    // Initialize Select2 for customer search with dropdownParent fix
    $('#customerSearchSelect').select2({
        theme: 'bootstrap-5',
        placeholder: 'Search by account number or name',
        allowClear: true,
        dropdownParent: $('#addCustomerModal'),
        minimumInputLength: 2,
        ajax: {
            url: '/api/customers/search',
            dataType: 'json',
            delay: 250,
            data: function(params) {
                return { q: params.term };
            },
            processResults: function(data) {
                return {
                    results: data.map(customer => ({
                        id: customer.id,
                        text: `${customer.account_number} - ${customer.name}`,
                        customer: customer
                    }))
                };
            },
            cache: true
        }
    }).on('select2:select', function(e) {
        selectedCustomerId = e.params.data.id;
        const customer = e.params.data.customer;
        document.getElementById('selectedCustomerDetails').innerHTML = 
            `${customer.account_number} - ${customer.name}`;
        document.getElementById('selectedCustomerInfo').style.display = 'block';
    });
    
    // Initialize drag-and-drop for all sortable lists
    document.querySelectorAll('.sortable-list').forEach(list => {
        new Sortable(list, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            onEnd: function(evt) {
                const entryId = evt.item.dataset.entryId;
                const newPosition = evt.newIndex + 1;
                updateEntryPosition(entryId, newPosition);
            }
        });
    });
});

// Utility functions
function showLoading() {
    document.getElementById('loadingSpinner').classList.add('show');
}

function hideLoading() {
    document.getElementById('loadingSpinner').classList.remove('show');
}

function showToast(message, type = 'success') {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    const container = document.getElementById('toastContainer');
    container.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = container.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
}

// Callsheet Management
function showAddCallsheetModal(day) {
    document.getElementById('callsheetModalTitle').textContent = 'Add New Callsheet';
    document.getElementById('callsheetId').value = '';
    document.getElementById('callsheetName').value = '';
    if (day) {
        document.getElementById('callsheetDay').value = day;
    }
    callsheetModal.show();
}

function editCallsheet(event, id, name, day) {
    event.stopPropagation();
    event.preventDefault();
    document.getElementById('callsheetModalTitle').textContent = 'Edit Callsheet';
    document.getElementById('callsheetId').value = id;
    document.getElementById('callsheetName').value = name;
    document.getElementById('callsheetDay').value = day;
    callsheetModal.show();
}

async function saveCallsheet() {
    const id = document.getElementById('callsheetId').value;
    const name = document.getElementById('callsheetName').value;
    const day = document.getElementById('callsheetDay').value;
    
    if (!name) {
        showToast('Please enter a callsheet name', 'warning');
        return;
    }
    
    showLoading();
    
    try {
        const url = id ? `/api/callsheet/${id}/update` : '/api/callsheet/create';
        const body = id ? 
            { name: name, day_of_week: day } : 
            { name: name, day_of_week: day, month: {{ current_month }}, year: {{ current_year }} };
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.success) {
            callsheetModal.hide();
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        showToast('Error: ' + error.message, 'danger');
    }
}

function deleteCallsheet(event, callsheetId) {
    event.stopPropagation();
    event.preventDefault();
    
    if (!confirm('Are you sure you want to delete this callsheet? All entries will be removed.')) {
        return;
    }
    
    showLoading();
    
    fetch(`/api/callsheet/${callsheetId}/delete`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('Error: ' + error.message, 'danger');
    });
}

// Call Status Management
function confirmStatusChange(selectElement, entryId) {
    const newStatus = selectElement.value;
    const oldStatus = selectElement.dataset.currentStatus;
    
    // If reverting to not_called, just do it directly
    if (newStatus === 'not_called') {
        saveCallStatusDirect(entryId, newStatus, selectElement);
        return;
    }
    
    // For other statuses, show confirmation modal
    document.getElementById('statusEntryId').value = entryId;
    document.getElementById('statusValue').value = newStatus;
    
    // Reset fields
    document.getElementById('callbackDetails').style.display = 'none';
    document.getElementById('personSpokenTo').value = '';
    document.getElementById('callbackTime').value = '';
    
    // Set modal title based on status
    if (newStatus === 'ordered') {
        document.getElementById('statusModalTitle').textContent = 'Record Order';
    } else if (newStatus === 'callback') {
        document.getElementById('callbackDetails').style.display = 'block';
        document.getElementById('statusModalTitle').textContent = 'Schedule Callback';
    } else if (newStatus === 'no_answer') {
        document.getElementById('statusModalTitle').textContent = 'No Answer';
    } else if (newStatus === 'declined') {
        document.getElementById('statusModalTitle').textContent = 'Customer Declined';
    }
    
    statusModal.show();
    
    // Reset select if user cancels
    document.getElementById('statusModal').addEventListener('hidden.bs.modal', function handler() {
        if (selectElement.value !== selectElement.dataset.currentStatus && 
            document.getElementById('statusEntryId').value == entryId) {
            selectElement.value = oldStatus;
        }
        this.removeEventListener('hidden.bs.modal', handler);
    }, { once: true });
}

async function saveCallStatus() {
    const entryId = document.getElementById('statusEntryId').value;
    const status = document.getElementById('statusValue').value;
    
    let data = { call_status: status };
    
    // Always include person_spoken_to if filled (for any status)
    const personSpokenTo = document.getElementById('personSpokenTo').value;
    if (personSpokenTo) {
        data.person_spoken_to = personSpokenTo;
    }
    
    // Add callback time if applicable
    if (status === 'callback') {
        data.callback_time = document.getElementById('callbackTime').value;
    }
    
    showLoading();
    
    try {
        const response = await fetch(`/api/callsheet-entry/${entryId}/update-status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            statusModal.hide();
            showToast(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(result.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        showToast('Error: ' + error.message, 'danger');
    }
}

async function saveCallStatusDirect(entryId, status, selectElement) {
    showLoading();
    
    try {
        const response = await fetch(`/api/callsheet-entry/${entryId}/update-status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ call_status: status })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            selectElement.dataset.currentStatus = status;
            showToast(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            selectElement.value = selectElement.dataset.currentStatus;
            showToast(result.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        selectElement.value = selectElement.dataset.currentStatus;
        showToast('Error: ' + error.message, 'danger');
    }
}

// Notes Management
function showNotesModal(entryId, customerId, notes) {
    document.getElementById('notesEntryId').value = entryId;
    document.getElementById('notesCustomerId').value = customerId;
    document.getElementById('notesText').value = notes || '';
    notesModal.show();
}

async function saveNotes() {
    const entryId = document.getElementById('notesEntryId').value;
    const notes = document.getElementById('notesText').value;
    
    showLoading();
    
    try {
        const response = await fetch(`/api/callsheet-entry/${entryId}/update-notes`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ notes: notes })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            notesModal.hide();
            showToast(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(result.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        showToast('Error: ' + error.message, 'danger');
    }
}

function clearNotes() {
    if (confirm('Are you sure you want to clear these notes? This will permanently delete them.')) {
        document.getElementById('notesText').value = '';
        saveNotes();
    }
}

// Customer Management
function showAddCustomerModal(callsheetId) {
    document.getElementById('addCallsheetId').value = callsheetId;
    
    // Clear and reset Select2
    const $select = $('#customerSearchSelect');
    $select.val(null).trigger('change');
    $select.empty().append('<option></option>');
    
    $('#selectedCustomerInfo').hide();
    selectedCustomerId = null;
    addCustomerModal.show();
}

async function addCustomerToCallsheet() {
    const callsheetId = document.getElementById('addCallsheetId').value;
    
    if (!selectedCustomerId) {
        showToast('Please select a customer', 'warning');
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch(`/api/callsheet/${callsheetId}/add-customer`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({customer_id: selectedCustomerId})
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.success) {
            addCustomerModal.hide();
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        showToast('Error: ' + error.message, 'danger');
    }
}

function removeCustomer(entryId) {
    if (!confirm('Remove this customer from the callsheet?')) {
        return;
    }
    
    showLoading();
    
    fetch(`/api/callsheet-entry/${entryId}/delete`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('Error: ' + error.message, 'danger');
    });
}

// Pause/Resume customer
async function togglePauseCustomer(entryId) {
    showLoading();
    
    try {
        const response = await fetch(`/api/callsheet-entry/${entryId}/toggle-pause`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'danger');
        }
    } catch (error) {
        hideLoading();
        showToast('Error: ' + error.message, 'danger');
    }
}

// Drag and drop reordering
async function updateEntryPosition(entryId, newPosition) {
    try {
        const response = await fetch(`/api/callsheet-entry/${entryId}/reorder`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ position: newPosition })
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('Order updated', 'success');
        } else {
            showToast(result.message, 'danger');
            location.reload();
        }
    } catch (error) {
        showToast('Error updating order', 'danger');
        location.reload();
    }
}

// Week/Month Management
function resetWeek() {
    if (!confirm('Reset all callsheets to "Not Called" status? Customer notes will be preserved.')) {
        return;
    }
    
    showLoading();
    
    fetch('/api/callsheets/reset-week', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            month: {{ current_month }},
            year: {{ current_year }}
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('Error: ' + error.message, 'danger');
    });
}

function archiveMonth() {
    if (!confirm('Archive all callsheets for {{ month_name }} {{ current_year }}? This will mark them as inactive.')) {
        return;
    }
    
    showLoading();
    
    fetch('/api/callsheets/archive', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            month: {{ current_month }},
            year: {{ current_year }}
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message, 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showToast('Error: ' + error.message, 'danger');
    });
}

function viewArchivedCallsheets() {
    // Simple navigation to archive page
    window.location.href = `/callsheets/archive/{{ current_month }}/{{ current_year }}`;
}
</script>

{% endblock %}