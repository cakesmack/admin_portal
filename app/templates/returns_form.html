{% extends "base.html" %} {% block content %}
<h2>Product Returns Form</h2>
<p class="text-muted">Create a digital return form for customer products</p>

<div class="card mt-4">
  <div class="card-body">
    <form method="POST" action="{{ url_for('main.returns') }}" id="returnsForm">
      {{ form.hidden_tag() }}

      <!-- Hidden fields for data -->
      <input
        type="hidden"
        name="additional_products"
        id="additional_products"
        value=""
      />
      <input type="hidden" name="address_label" id="address_label" value="" />

      <!-- Customer Details Section -->
      <div class="row mb-4">
        <div class="col-12">
          <h5 class="border-bottom pb-2 mb-3">Customer Details</h5>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <div class="search-container position-relative">
            {{ form.customer_account.label(class="form-label") }} {{
            form.customer_account(class="form-control", placeholder="Start
            typing account number...") }}
          </div>
        </div>
        <div class="col-md-4">
          <div class="search-container position-relative">
            {{ form.customer_name.label(class="form-label") }} {{
            form.customer_name(class="form-control", placeholder="Start typing
            customer name...") }}
          </div>
        </div>
        <div class="col-md-4">
          {{ form.customer_address.label(class="form-label") }} {{
          form.customer_address(class="form-control", placeholder="Customer
          address", readonly=true) }}
        </div>
      </div>

      <!-- Address Selection Container (populated by script.js) -->
      <div
        id="addressSelectionContainer"
        class="address-selection-area mb-3"
      ></div>

      <!-- Products Section -->
      <div class="row mb-4">
        <div class="col-12">
          <h5 class="border-bottom pb-2 mb-3">Product Details</h5>
        </div>
      </div>

      <!-- Main Product -->
      <div class="row mb-3 product-row" id="main-product">
        <div class="col-md-4">
          <div class="search-container position-relative">
            {{ form.product_code.label(class="form-label") }} {{
            form.product_code(class="form-control product-code",
            placeholder="Start typing product code...") }}
          </div>
        </div>
        <div class="col-md-5">
          {{ form.product_name.label(class="form-label") }} {{
          form.product_name(class="form-control product-name",
          placeholder="Product description") }}
        </div>
        <div class="col-md-3">
          {{ form.quantity.label(class="form-label") }} {{
          form.quantity(class="form-control", type="number", min="1",
          placeholder="Quantity") }}
        </div>
      </div>

      <!-- Additional Products Container -->
      <div id="additional-products-container"></div>

      <div class="row mb-4">
        <div class="col-12">
          <button
            type="button"
            class="btn btn-success btn-sm"
            onclick="addProduct()"
          >
            <i class="bi bi-plus-circle"></i> Add Another Product
          </button>
        </div>
      </div>

      <!-- Return Details -->
      <div class="row mb-4">
        <div class="col-12">
          <h5 class="border-bottom pb-2 mb-3">Return Details</h5>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          {{ form.reason.label(class="form-label") }} {{
          form.reason(class="form-select") }}
        </div>
        <div class="col-md-6">
          {{ form.notes.label(class="form-label") }} {{
          form.notes(class="form-control", rows="3", placeholder="Any additional
          notes...") }}
        </div>
      </div>

      <div class="d-grid">
        {{ form.submit(class="btn btn-primary btn-lg") }}
      </div>
    </form>
  </div>
</div>

{% endblock %} {% block scripts %}
<script type="module">
  import {
    initCustomerSearch,
    initProductSearch,
    getSelectedAddress,
  } from "/static/js/script.js";

  let additionalProducts = [];

  document.addEventListener("DOMContentLoaded", function () {
    // Initialize customer search with address handling
    initCustomerSearch({
      accountInputId: "customer_account",
      nameInputId: "customer_name",
      addressInputId: "customer_address",
      addressContainerId: "addressSelectionContainer",
    });

    // Initialize product search for the main product
    initProductSearch();

    // Handle form submission
    const form = document.getElementById("returnsForm");
    if (form) {
      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const submitBtn = form.querySelector(
          'button[type="submit"], input[type="submit"]'
        );
        if (submitBtn.disabled) return;
        submitBtn.disabled = true;

        // Collect additional products
        updateAdditionalProducts();
        document.getElementById("additional_products").value =
          JSON.stringify(additionalProducts);

        // Get selected address - ENHANCED TO HANDLE NEW ADDRESSES
        const addressContainer = document.getElementById(
          "addressSelectionContainer"
        );
        const selectedAddressData = getSelectedAddress(addressContainer);

        if (selectedAddressData) {
          if (selectedAddressData.isNew) {
            // New address - validate it has required fields
            if (!selectedAddressData.label) {
              alert("Please provide a location name for the new address");
              submitBtn.disabled = false;
              return;
            }

            // Store new address data as JSON in hidden field
            document.getElementById("address_label").value = "__NEW__";

            // Create hidden inputs for new address data
            const form = document.getElementById("returnsForm");
            ["label", "street", "city", "zip", "phone"].forEach((field) => {
              let input = form.querySelector(
                `input[name="new_address_${field}"]`
              );
              if (!input) {
                input = document.createElement("input");
                input.type = "hidden";
                input.name = `new_address_${field}`;
                form.appendChild(input);
              }
              input.value = selectedAddressData[field] || "";
            });

            console.log("✅ Submitting with NEW address:", selectedAddressData);
          } else {
            // Existing address
            document.getElementById("address_label").value =
              selectedAddressData.label;
            console.log(
              "✅ Submitting with EXISTING address:",
              selectedAddressData.label
            );
          }
        }

        const formData = new FormData(form);

        try {
          const response = await fetch(form.action, {
            method: "POST",
            body: formData,
          });

          const responseText = await response.text();

          if (response.ok) {
            try {
              const data = JSON.parse(responseText);
              if (data.success && data.form_id) {
                window.open(`/print-form/${data.form_id}`, "_blank");
                window.location.href = "/dashboard";
              }
            } catch (e) {
              // Handle non-JSON response (backward compatibility)
              const tempDiv = document.createElement("div");
              tempDiv.innerHTML = responseText;
              const scripts = tempDiv.getElementsByTagName("script");
              for (let script of scripts) {
                eval(script.innerHTML);
              }
            }
          } else {
            alert("Error submitting form. Please try again.");
            submitBtn.disabled = false;
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error submitting form. Please try again.");
          submitBtn.disabled = false;
        }
      });
    }
  });

  // Add new product row
  window.addProduct = function () {
    const container = document.getElementById("additional-products-container");
    const uniqueId = Date.now();

    const newRow = document.createElement("div");
    newRow.className = "row mb-3 product-row";
    newRow.innerHTML = `
      <div class="col-md-4">
        <div class="search-container position-relative">
          <label class="form-label">Product Code</label>
          <input type="text" class="form-control product-code" placeholder="Start typing code...">
        </div>
      </div>
      <div class="col-md-5">
        <label class="form-label">Product Name</label>
        <input type="text" class="form-control product-name" placeholder="Product description">
      </div>
      <div class="col-md-2">
        <label class="form-label">Quantity</label>
        <input type="number" class="form-control product-quantity" min="1" value="1">
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button type="button" class="btn btn-danger" onclick="removeProduct(this)">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    `;

    container.appendChild(newRow);

    // Initialize product search for the new row
    initProductSearch(newRow);
  };

  // Remove product row
  window.removeProduct = function (button) {
    button.closest(".product-row").remove();
  };

  // Collect additional products for submission
  function updateAdditionalProducts() {
    additionalProducts = [];
    const additionalRows = document.querySelectorAll(
      "#additional-products-container .product-row"
    );

    additionalRows.forEach((row) => {
      const code = row.querySelector(".product-code").value.trim();
      const name = row.querySelector(".product-name").value.trim();
      const quantity = row.querySelector(".product-quantity").value;

      if (code && name && quantity) {
        additionalProducts.push({
          product_code: code,
          product_name: name,
          quantity: parseInt(quantity),
        });
      }
    });
  }
</script>
{% endblock %}
