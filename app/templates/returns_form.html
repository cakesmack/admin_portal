{% extends "base.html" %} {% block content %}
<h2>Product Returns Form</h2>
<p class="text-muted">Create a digital return form for customer products</p>

<div class="card mt-4">
  <div class="card-body">
    <form method="POST" action="{{ url_for('main.returns') }}">
      {{ form.hidden_tag() }}
      <div class="row mb-3">
        <div class="col-md-6">
          {{ form.customer_account.label(class="form-label") }} {{
          form.customer_account(class="form-control") }}
          <div class="form-text">Enter customer account number</div>
          {{ form.customer_name.label(class="form-label") }} {{
          form.customer_name(class="form-control") }}
        </div>
        <div class="col-md-6">
          {{ form.customer_address.label(class="form-label") }} {{
          form.customer_address(class="form-control") }}
        </div>
      </div>
      <br />
      <div class="row mb-3">
        <div class="col-md-6">
          {{ form.product_code.label(class="form-label") }} {{
          form.product_code(class="form-control") }}
        </div>
        <div class="col-md-6">
          {{ form.product_name.label(class="form-label") }} {{
          form.product_name(class="form-control") }}
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          {{ form.price.label(class="form-label") }} {{
          form.price(class="form-control", type="number", min="1") }}
        </div>
        <div class="col-md-4">
          {{ form.quantity.label(class="form-label") }} {{
          form.quantity(class="form-control", type="number", min="1") }}
        </div>
        <div class="col-md-4">
          {{ form.reason.label(class="form-label") }} {{
          form.reason(class="form-select") }}
        </div>
      </div>

      <div class="mb-3">
        {{ form.notes.label(class="form-label") }} {{
        form.notes(class="form-control", rows="3") }}
      </div>

      <div class="d-grid">{{ form.submit(class="btn btn-primary") }}</div>
    </form>
  </div>
</div>
{% block scripts %}
<script>
  let searchTimeout;
  let currentResults = [];

  document.addEventListener("DOMContentLoaded", function () {
    const accountInput = document.querySelector(
      'input[name="customer_account"]'
    );
    const nameInput = document.querySelector('input[name="customer_name"]');

    // Add search functionality to BOTH fields
    if (accountInput) {
      setupSearchField(accountInput, "account");
    }

    if (nameInput) {
      setupSearchField(nameInput, "name");
    }

    // Close dropdown when clicking outside
    document.addEventListener("click", function (e) {
      if (!e.target.closest(".search-container")) {
        hideAllDropdowns();
      }
    });
  });

  function setupSearchField(input, fieldType) {
    // Wrap the input in a container for positioning
    if (!input.parentElement.classList.contains("search-container")) {
      const container = document.createElement("div");
      container.className = "search-container position-relative";
      input.parentNode.insertBefore(container, input);
      container.appendChild(input);
    }

    input.addEventListener("input", function () {
      clearTimeout(searchTimeout);
      const searchValue = this.value.trim();

      if (searchValue.length < 2) {
        hideDropdown(input);
        clearOtherFields(fieldType);
        return;
      }

      // Debounce search
      searchTimeout = setTimeout(() => {
        searchCustomers(searchValue, input, fieldType);
      }, 300);
    });

    input.addEventListener("blur", function () {
      // Delay hiding dropdown to allow clicking on results
      setTimeout(() => {
        if (!document.querySelector(".dropdown-results:hover")) {
          hideDropdown(input);
        }
      }, 200);
    });
  }

  async function searchCustomers(searchValue, inputElement, fieldType) {
    try {
      const response = await fetch(
        `/api/customers/search?q=${encodeURIComponent(searchValue)}`
      );
      const customers = await response.json();

      currentResults = customers;
      showDropdown(customers, inputElement, fieldType);
    } catch (error) {
      console.error("Error searching customers:", error);
      hideDropdown(inputElement);
    }
  }

  function showDropdown(customers, inputElement, fieldType) {
    // Remove existing dropdown
    hideDropdown(inputElement);

    if (customers.length === 0) {
      inputElement.style.borderColor = "#dc3545";
      return;
    }

    // Create dropdown
    const dropdown = document.createElement("div");
    dropdown.className = "dropdown-results";
    dropdown.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--dark-card);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    `;

    customers.forEach((customer, index) => {
      const item = document.createElement("div");
      item.className = "dropdown-item-custom";
      item.style.cssText = `
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            color: var(--text-light);
        `;

      item.innerHTML = `
            <div style="font-weight: 600;">${customer.account_number} - ${
        customer.name
      }</div>
            <small style="color: var(--text-muted);">
                ${
                  customer.contact_name
                    ? "Contact: " + customer.contact_name
                    : ""
                }
                ${customer.phone ? " | Phone: " + customer.phone : ""}
            </small>
        `;

      // Hover effect
      item.addEventListener("mouseenter", function () {
        this.style.backgroundColor = "var(--primary-blue)";
      });

      item.addEventListener("mouseleave", function () {
        this.style.backgroundColor = "transparent";
      });

      // Click to select
      item.addEventListener("click", function () {
        selectCustomer(customer);
        hideAllDropdowns();
      });

      dropdown.appendChild(item);
    });

    // Add to container
    inputElement.parentElement.appendChild(dropdown);
    inputElement.style.borderColor = "#28a745";
  }

  function selectCustomer(customer) {
    // Fill both fields
    const accountInput = document.querySelector(
      'input[name="customer_account"]'
    );
    const nameInput = document.querySelector('input[name="customer_name"]');

    if (accountInput) {
      accountInput.value = customer.account_number;
      accountInput.style.borderColor = "#28a745";
    }

    if (nameInput) {
      nameInput.value = customer.name;
      nameInput.style.borderColor = "#28a745";
    }

    // Show customer info
    showCustomerInfo(customer);
  }

  function hideDropdown(inputElement) {
    const existing =
      inputElement.parentElement.querySelector(".dropdown-results");
    if (existing) {
      existing.remove();
    }
  }

  function hideAllDropdowns() {
    document.querySelectorAll(".dropdown-results").forEach((dropdown) => {
      dropdown.remove();
    });
  }

  function clearOtherFields(fieldType) {
    if (fieldType === "account") {
      const nameInput = document.querySelector('input[name="customer_name"]');
      if (nameInput) {
        nameInput.value = "";
        nameInput.style.borderColor = "";
      }
    } else {
      const accountInput = document.querySelector(
        'input[name="customer_account"]'
      );
      if (accountInput) {
        accountInput.value = "";
        accountInput.style.borderColor = "";
      }
    }
    hideCustomerInfo();
  }

  function showCustomerInfo(customer) {
    hideCustomerInfo();

    const infoDiv = document.createElement("div");
    infoDiv.id = "customer-info";
    infoDiv.className = "alert alert-success mt-3";
    infoDiv.innerHTML = `
        <strong>âœ“ Customer Selected:</strong><br>
        <div class="row">
            <div class="col-md-6">
                <small>
                    <strong>Account:</strong> ${customer.account_number}<br>
                    <strong>Name:</strong> ${customer.name}
                </small>
            </div>
            <div class="col-md-6">
                <small>
                    <strong>Contact:</strong> ${
                      customer.contact_name || "N/A"
                    }<br>
                    <strong>Phone:</strong> ${customer.phone || "N/A"}
                </small>
            </div>
        </div>
    `;

    // Insert after the second customer field
    const nameField = document
      .querySelector('input[name="customer_name"]')
      .closest(".col-md-6");
    nameField.insertAdjacentElement("afterend", infoDiv);
  }

  function hideCustomerInfo() {
    const existingInfo = document.getElementById("customer-info");
    if (existingInfo) {
      existingInfo.remove();
    }
  }
</script>

<style>
  .search-container {
    position: relative;
  }

  .dropdown-results {
    border: 2px solid var(--border-color) !important;
    background: var(--dark-card) !important;
  }

  .dropdown-results::-webkit-scrollbar {
    width: 6px;
  }

  .dropdown-results::-webkit-scrollbar-track {
    background: var(--dark-bg);
  }

  .dropdown-results::-webkit-scrollbar-thumb {
    background: var(--primary-blue);
    border-radius: 3px;
  }
</style>
{% endblock %} {% endblock %}
