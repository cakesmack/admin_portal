{% extends "base.html" %} {% block content %}
<h2>Product Returns Form</h2>
<p class="text-muted">Create a digital return form for customer products</p>

<div class="card mt-4">
  <div class="card-body">
    <form method="POST" action="{{ url_for('main.returns') }}" id="returnsForm">
      {{ form.hidden_tag() }}

      <!-- Hidden field for additional products -->
      <input
        type="hidden"
        name="additional_products"
        id="additional_products"
        value=""
      />

      <div class="row mb-3">
        <div class="col-md-4">
          <div class="search-container position-relative">
            {{ form.customer_account.label(class="form-label") }} {{
            form.customer_account(class="form-control", placeholder="Start
            typing account number...") }}
          </div>
        </div>
        <div class="col-md-4">
          <div class="search-container position-relative">
            {{ form.customer_name.label(class="form-label") }} {{
            form.customer_name(class="form-control", placeholder="Start typing
            customer name...") }}
          </div>
        </div>
        <div class="col-md-4">
          {{ form.customer_address.label(class="form-label") }} {{
          form.customer_address(class="form-control", placeholder="Customer
          address") }}
        </div>
      </div>

      <!-- Products Section -->
      <div class="row mb-4">
        <div class="col-12">
          <h5 class="border-bottom pb-2 mb-3">Product Details</h5>
        </div>
      </div>

      <!-- Main Product (original form fields) -->
      <div class="row mb-3" id="main-product">
        <div class="col-md-4">
          <div class="search-container position-relative">
            {{ form.product_code.label(class="form-label") }} {{
            form.product_code(class="form-control", placeholder="Start typing
            product code...") }}
          </div>
        </div>
        <div class="col-md-5">
          {{ form.product_name.label(class="form-label") }} {{
          form.product_name(class="form-control", placeholder="Product
          description") }}
        </div>
        <div class="col-md-3">
          {{ form.quantity.label(class="form-label") }} {{
          form.quantity(class="form-control", type="number", min="1",
          placeholder="Quantity") }}
        </div>
      </div>

      <!-- Additional Products Container -->
      <div id="additional-products-container"></div>

      <div class="row mb-4">
        <div class="col-12">
          <button
            type="button"
            class="btn btn-success btn-sm"
            onclick="addProduct()"
          >
            <i class="bi bi-plus-circle"></i> Add Another Product
          </button>
        </div>
      </div>

      <!-- Return Details -->
      <div class="row mb-4">
        <div class="col-12">
          <h5 class="border-bottom pb-2 mb-3">Return Details</h5>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          {{ form.reason.label(class="form-label") }} {{
          form.reason(class="form-select") }}
        </div>
        <div class="col-md-6">
          {{ form.notes.label(class="form-label") }} {{
          form.notes(class="form-control", rows="3", placeholder="Any additional
          notes...") }}
        </div>
      </div>

      <div class="d-grid">
        {{ form.submit(class="btn btn-primary btn-lg") }}
      </div>
    </form>
  </div>
</div>

{% block scripts %}
<script>
  let searchTimeout;
  let additionalProducts = [];

  document.addEventListener("DOMContentLoaded", function () {
    // Setup search for customer fields
    setupCustomerSearch();

    // Setup search for main product field
    setupProductSearch(document.querySelector('input[name="product_code"]'));

    // Close dropdowns when clicking outside
    document.addEventListener("click", function (e) {
      if (!e.target.closest(".search-container")) {
        hideAllDropdowns();
      }
    });

    // Update hidden field before form submission
    document
      .getElementById("returnsForm")
      .addEventListener("submit", function () {
        document.getElementById("additional_products").value =
          JSON.stringify(additionalProducts);
      });
  });

  function setupCustomerSearch() {
    const accountInput = document.querySelector(
      'input[name="customer_account"]'
    );
    const nameInput = document.querySelector('input[name="customer_name"]');

    if (accountInput) {
      setupSearchField(accountInput, "customer", "account");
    }

    if (nameInput) {
      setupSearchField(nameInput, "customer", "name");
    }
  }

  function setupProductSearch(input) {
    if (input) {
      setupSearchField(input, "product", "code");
    }
  }

  function setupSearchField(input, type, field) {
    input.addEventListener("input", function () {
      clearTimeout(searchTimeout);
      const searchValue = this.value.trim();

      if (searchValue.length < 2) {
        hideDropdown(input);
        if (type === "customer") {
          clearOtherCustomerFields(field);
        }
        return;
      }

      searchTimeout = setTimeout(() => {
        if (type === "customer") {
          searchCustomers(searchValue, input, field);
        } else {
          searchProducts(searchValue, input);
        }
      }, 300);
    });

    input.addEventListener("blur", function () {
      setTimeout(() => {
        if (!document.querySelector(".dropdown-results:hover")) {
          hideDropdown(input);
        }
      }, 200);
    });
  }

  async function searchCustomers(searchValue, inputElement, fieldType) {
    try {
      const response = await fetch(
        `/api/customers/search?q=${encodeURIComponent(searchValue)}`
      );
      const customers = await response.json();

      showCustomerDropdown(customers, inputElement, fieldType);
    } catch (error) {
      console.error("Error searching customers:", error);
      hideDropdown(inputElement);
    }
  }

  async function searchProducts(searchValue, inputElement) {
    try {
      const response = await fetch(
        `/api/products/search?q=${encodeURIComponent(searchValue)}`
      );
      const products = await response.json();
      showProductDropdown(products, inputElement);
    } catch (error) {
      console.error("Error searching products:", error);
      hideDropdown(inputElement);
    }
  }

  function showCustomerDropdown(customers, inputElement, fieldType) {
    hideDropdown(inputElement);

    if (customers.length === 0) {
      inputElement.style.borderColor = "#dc3545";
      return;
    }

    const dropdown = createDropdown();

    customers.forEach((customer) => {
      const item = createDropdownItem(
        `${customer.account_number} - ${customer.name}`,
        customer.contact_name ? `Contact: ${customer.contact_name}` : ""
      );

      item.addEventListener("click", function () {
        selectCustomer(customer);
        hideAllDropdowns();
      });

      dropdown.appendChild(item);
    });

    inputElement.parentElement.appendChild(dropdown);
    inputElement.style.borderColor = "#28a745";
  }

  function showProductDropdown(products, inputElement) {
    hideDropdown(inputElement);

    if (products.length === 0) {
      inputElement.style.borderColor = "#dc3545";
      return;
    }

    const dropdown = createDropdown();

    products.forEach((product) => {
      const item = createDropdownItem(`${product.code}`, `${product.name}`);

      item.addEventListener("click", function () {
        selectProduct(product, inputElement);
        hideAllDropdowns();
      });

      dropdown.appendChild(item);
    });

    inputElement.parentElement.appendChild(dropdown);
    inputElement.style.borderColor = "#28a745";
  }

  function createDropdown() {
    const dropdown = document.createElement("div");
    dropdown.className = "dropdown-results";
    dropdown.style.cssText = `
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--dark-card);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    `;
    return dropdown;
  }

  function createDropdownItem(title, subtitle) {
    const item = document.createElement("div");
    item.className = "dropdown-item-custom";
    item.style.cssText = `
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
        color: var(--text-light);
    `;

    item.innerHTML = `
        <div style="font-weight: 600;">${title}</div>
        ${
          subtitle
            ? `<small style="color: var(--text-muted);">${subtitle}</small>`
            : ""
        }
    `;

    item.addEventListener("mouseenter", function () {
      this.style.backgroundColor = "var(--primary-blue)";
    });

    item.addEventListener("mouseleave", function () {
      this.style.backgroundColor = "transparent";
    });

    return item;
  }

  function selectCustomer(customer) {
    const accountInput = document.querySelector(
      'input[name="customer_account"]'
    );
    const nameInput = document.querySelector('input[name="customer_name"]');
    const addressInput = document.querySelector(
      'input[name="customer_address"]'
    );

    if (accountInput) {
      accountInput.value = customer.account_number;
      accountInput.style.borderColor = "#28a745";
    }

    if (nameInput) {
      nameInput.value = customer.name;
      nameInput.style.borderColor = "#28a745";
    }

    if (addressInput && customer.address) {
      addressInput.value = customer.address;
    }
  }

  function selectProduct(product, inputElement) {
    const isMainProduct = inputElement.name === "product_code";

    if (isMainProduct) {
      // Main product fields
      inputElement.value = product.code;
      inputElement.style.borderColor = "#28a745";

      const nameInput = document.querySelector('input[name="product_name"]');
      if (nameInput) {
        nameInput.value = product.name;
      }
    } else {
      // Additional product
      const productRow = inputElement.closest(".additional-product-row");
      const codeInput = productRow.querySelector(".additional-product-code");
      const nameInput = productRow.querySelector(".additional-product-name");

      if (codeInput) {
        codeInput.value = product.code;
        codeInput.style.borderColor = "#28a745";
      }

      if (nameInput) {
        nameInput.value = product.name;
      }
    }
  }

  function clearOtherCustomerFields(fieldType) {
    if (fieldType === "account") {
      const nameInput = document.querySelector('input[name="customer_name"]');
      if (nameInput) {
        nameInput.value = "";
        nameInput.style.borderColor = "";
      }
    } else {
      const accountInput = document.querySelector(
        'input[name="customer_account"]'
      );
      if (accountInput) {
        accountInput.value = "";
        accountInput.style.borderColor = "";
      }
    }
  }

  function hideDropdown(inputElement) {
    const existing =
      inputElement.parentElement.querySelector(".dropdown-results");
    if (existing) {
      existing.remove();
    }
  }

  function hideAllDropdowns() {
    document.querySelectorAll(".dropdown-results").forEach((dropdown) => {
      dropdown.remove();
    });
  }

  let productCounter = 0;

  function addProduct() {
    const container = document.getElementById("additional-products-container");
    const productId = `additional-product-${productCounter}`;

    const newRow = document.createElement("div");
    newRow.className = "additional-product-row row mb-3 p-3 border rounded";
    newRow.style.backgroundColor = "rgba(255, 255, 255, 0.02)";

    newRow.innerHTML = `
        <div class="col-md-4">
            <div class="search-container position-relative">
                <label class="form-label">Product Code</label>
                <input class="form-control additional-product-code" 
                       placeholder="Start typing product code..." type="text">
            </div>
        </div>
        <div class="col-md-5">
            <label class="form-label">Product Name</label>
            <input class="form-control additional-product-name" 
                   placeholder="Product description" type="text">
        </div>
        <div class="col-md-2">
            <label class="form-label">Quantity</label>
            <input class="form-control additional-product-quantity" 
                   type="number" min="1" placeholder="Qty">
        </div>
        <div class="col-md-1 d-flex align-items-end">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeProduct(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;

    container.appendChild(newRow);

    // Setup search for the new product code input
    const newCodeInput = newRow.querySelector(".additional-product-code");
    setupProductSearch(newCodeInput);

    productCounter++;
  }

  function removeProduct(button) {
    button.closest(".additional-product-row").remove();
    updateAdditionalProducts();
  }

  function updateAdditionalProducts() {
    additionalProducts = [];

    document.querySelectorAll(".additional-product-row").forEach((row) => {
      const code = row.querySelector(".additional-product-code").value;
      const name = row.querySelector(".additional-product-name").value;
      const quantity = row.querySelector(".additional-product-quantity").value;

      if (code && name && quantity) {
        additionalProducts.push({
          product_code: code,
          product_name: name,
          quantity: quantity,
        });
      }
    });
  }

  // Update additional products before form submission
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("returnsForm");

    if (form) {
      // Remove any existing submit listeners and add the AJAX one
      form.addEventListener("submit", async function (e) {
        e.preventDefault(); // Prevent normal form submission

        // Update additional products
        updateAdditionalProducts();
        document.getElementById("additional_products").value =
          JSON.stringify(additionalProducts);

        // Get form data
        const formData = new FormData(form);

        try {
          // Submit via AJAX
          const response = await fetch(form.action, {
            method: "POST",
            body: formData,
          });

          const responseText = await response.text();

          // Check if response contains form ID (successful submission)
          // The Flask route will return JSON with the form_id
          if (response.ok) {
            // Parse the response to get form_id
            // The backend should return JSON like: {"success": true, "form_id": 123}
            try {
              const data = JSON.parse(responseText);
              if (data.success && data.form_id) {
                // Open print window
                window.open(`/print-form/${data.form_id}`, "_blank");
                // Redirect to dashboard
                window.location.href = "/dashboard";
              }
            } catch (e) {
              // If response is not JSON, try to execute it as HTML/JavaScript
              // (for backward compatibility if the route returns the script directly)
              const tempDiv = document.createElement("div");
              tempDiv.innerHTML = responseText;
              const scripts = tempDiv.getElementsByTagName("script");
              for (let script of scripts) {
                eval(script.innerHTML);
              }
            }
          } else {
            // Show error
            alert("Error submitting form. Please try again.");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error submitting form. Please try again.");
        }
      });
    }
  });
</script>

{% endblock %} {% endblock %}
