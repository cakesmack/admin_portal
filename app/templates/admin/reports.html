{% extends "base.html" %} {% block content %}
<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-graph-up-arrow"></i> Admin Reports & Analytics</h2>
    <button class="btn btn-primary" onclick="exportReport()">
      <i class="bi bi-download"></i> Export Report
    </button>
  </div>

  <!-- Date Range Selector -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-end">
        <div class="col-md-3">
          <label class="form-label">Report Period</label>
          <select
            class="form-select"
            id="reportPeriod"
            onchange="updateDateRange()"
          >
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="this_week">This Week</option>
            <option value="last_week">Last Week</option>
            <option value="this_month" selected>This Month</option>
            <option value="last_month">Last Month</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Start Date</label>
          <input type="date" class="form-control" id="startDate" />
        </div>
        <div class="col-md-3">
          <label class="form-label">End Date</label>
          <input type="date" class="form-control" id="endDate" />
        </div>
        <div class="col-md-3">
          <button class="btn btn-success w-100" onclick="loadAllReports()">
            <i class="bi bi-arrow-clockwise"></i> Generate Report
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Statistics -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-primary mb-0" id="totalFormsCount">-</h3>
          <small class="text-muted">Total Forms</small>
          <div class="mt-2">
            <span class="badge bg-success" id="completedFormsBadge"
              >- Completed</span
            >
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-success mb-0" id="standingOrdersCount">-</h3>
          <small class="text-muted">Standing Orders</small>
          <div class="mt-2">
            <span class="badge bg-primary" id="newOrdersBadge">- New</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-info mb-0" id="stockTransactionsCount">-</h3>
          <small class="text-muted">Stock Transactions</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-warning mb-0" id="callsheetEntriesCount">-</h3>
          <small class="text-muted">Callsheet Entries</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-activity"></i> Daily Activity Trend
          </h5>
        </div>
        <div class="card-body">
          <canvas id="dailyActivityChart" height="80"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-pie-chart-fill"></i> Forms by Type
          </h5>
        </div>
        <div class="card-body">
          <canvas id="formsTypeChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Callsheet Analytics Section -->
  <div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-telephone-fill"></i> Callsheet Performance Analysis
      </h5>
    </div>
    <div class="card-body">
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center bg-light">
            <div class="card-body">
              <h3 class="text-success mb-0" id="orderSuccessRate">-</h3>
              <small class="text-muted">Order Success Rate</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center bg-light">
            <div class="card-body">
              <h3 class="text-warning mb-0" id="noAnswerRate">-</h3>
              <small class="text-muted">No Answer Rate</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center bg-light">
            <div class="card-body">
              <h3 class="text-danger mb-0" id="declineRate">-</h3>
              <small class="text-muted">Decline Rate</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center bg-light">
            <div class="card-body">
              <h3 class="text-info mb-0" id="callbackRate">-</h3>
              <small class="text-muted">Callback Rate</small>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Call Status Breakdown</h6>
            </div>
            <div class="card-body">
              <canvas id="callsheetStatusChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Daily Call Success Trend</h6>
            </div>
            <div class="card-body">
              <canvas id="dailyCallSuccessChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Best Performing Days</h6>
            </div>
            <div class="card-body">
              <canvas id="dayPerformanceChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Staff Call Performance</h6>
            </div>
            <div class="card-body">
              <canvas id="staffCallPerformanceChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Callsheet Insights Tables -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            <i class="bi bi-star-fill"></i> Most Responsive Customers
          </h6>
        </div>
        <div class="card-body">
          <div id="mostResponsiveCustomers">
            <div class="text-center text-muted">Loading...</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-warning text-white">
          <h6 class="mb-0">
            <i class="bi bi-clock-history"></i> Hard to Reach Customers
          </h6>
        </div>
        <div class="card-body">
          <div id="hardToReachCustomers">
            <div class="text-center text-muted">Loading...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-danger text-white">
          <h6 class="mb-0">
            <i class="bi bi-x-circle-fill"></i> Frequent Decliners
          </h6>
        </div>
        <div class="card-body">
          <div id="frequentDecliners">
            <div class="text-center text-muted">Loading...</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">
            <i class="bi bi-telephone-forward-fill"></i> Pending Callbacks
          </h6>
        </div>
        <div class="card-body">
          <div id="pendingCallbacks">
            <div class="text-center text-muted">Loading...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Activity Table -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-people-fill"></i> Staff Activity Report
      </h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Staff Member</th>
              <th>Forms Created</th>
              <th>Calls Made</th>
              <th>Stock Transactions</th>
              <th>Total Activity</th>
            </tr>
          </thead>
          <tbody id="userActivityTable">
            <tr>
              <td colspan="5" class="text-center text-muted">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Inactive Customers -->
  <div class="card mb-4">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-exclamation-triangle-fill"></i> Inactive Customers
        </h5>
        <select
          class="form-select w-auto"
          id="inactivePeriod"
          onchange="loadInactiveCustomers()"
        >
          <option value="30" selected>30 days</option>
          <option value="60">60 days</option>
          <option value="90">90 days</option>
        </select>
      </div>
    </div>
    <div class="card-body">
      <div id="inactiveCustomersList">
        <div class="text-center text-muted">Loading...</div>
      </div>
    </div>
  </div>
</div>

<script>
  let dailyActivityChart, formsTypeChart, callsheetStatusChart;
  let dailyCallSuccessChart, dayPerformanceChart, staffCallPerformanceChart;

  function updateDateRange() {
    const period = document.getElementById("reportPeriod").value;
    let startDate, endDate;

    switch (period) {
      case "today":
        startDate = new Date();
        endDate = new Date();
        break;
      case "yesterday":
        startDate = new Date();
        startDate.setDate(startDate.getDate() - 1);
        endDate = new Date(startDate);
        break;
      case "this_week":
        const thisWeekStart = new Date();
        thisWeekStart.setDate(
          thisWeekStart.getDate() - thisWeekStart.getDay() + 1
        );
        startDate = thisWeekStart;
        endDate = new Date();
        break;
      case "last_week":
        const lastWeekStart = new Date();
        lastWeekStart.setDate(
          lastWeekStart.getDate() - lastWeekStart.getDay() - 6
        );
        const lastWeekEnd = new Date(lastWeekStart);
        lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
        startDate = lastWeekStart;
        endDate = lastWeekEnd;
        break;
      case "this_month":
        startDate = new Date(
          new Date().getFullYear(),
          new Date().getMonth(),
          1
        );
        endDate = new Date();
        break;
      case "last_month":
        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        startDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
        endDate = new Date(
          lastMonth.getFullYear(),
          lastMonth.getMonth() + 1,
          0
        );
        break;
      case "custom":
        return;
    }

    document.getElementById("startDate").value = formatDate(startDate);
    document.getElementById("endDate").value = formatDate(endDate);
  }

  function formatDate(date) {
    return date.toISOString().split("T")[0];
  }

  async function loadAllReports() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    if (!startDate || !endDate) {
      alert("Please select date range");
      return;
    }

    await Promise.all([
      loadSummary(startDate, endDate),
      loadDailyActivity(startDate, endDate),
      loadUserActivity(startDate, endDate),
      loadInactiveCustomers(),
      loadCallsheetAnalytics(startDate, endDate),
    ]);
  }

  async function loadSummary(startDate, endDate) {
    try {
      const response = await fetch(
        `/admin/api/reports/summary?start_date=${startDate}&end_date=${endDate}`
      );
      const data = await response.json();

      document.getElementById("totalFormsCount").textContent = data.forms.total;
      document.getElementById(
        "completedFormsBadge"
      ).textContent = `${data.forms.completed} Completed`;
      document.getElementById("standingOrdersCount").textContent =
        data.standing_orders.active;
      document.getElementById(
        "newOrdersBadge"
      ).textContent = `${data.standing_orders.created_this_period} New`;
      document.getElementById("stockTransactionsCount").textContent =
        data.stock.total_transactions;
      document.getElementById("callsheetEntriesCount").textContent =
        data.callsheets.total_entries;

      updateFormsTypeChart(data.forms.by_type);
      updateCallsheetStatusChart(data.callsheets.by_status);
    } catch (error) {
      console.error("Error loading summary:", error);
    }
  }

  async function loadDailyActivity(startDate, endDate) {
    try {
      const response = await fetch(
        `/admin/api/reports/daily-activity?start_date=${startDate}&end_date=${endDate}`
      );
      const data = await response.json();

      if (data && data.length > 0) {
        updateDailyActivityChart(data);
      }
    } catch (error) {
      console.error("Error loading daily activity:", error);
    }
  }

  async function loadUserActivity(startDate, endDate) {
    try {
      const response = await fetch(
        `/admin/api/reports/user-activity?start_date=${startDate}&end_date=${endDate}`
      );
      const users = await response.json();

      const tableBody = document.getElementById("userActivityTable");
      tableBody.innerHTML = "";

      if (users.length === 0) {
        tableBody.innerHTML =
          '<tr><td colspan="5" class="text-center text-muted">No activity in selected period</td></tr>';
        return;
      }

      users.forEach((user) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><strong>${user.full_name}</strong><br><small class="text-muted">${user.username}</small></td>
          <td class="text-center">${user.forms_created}</td>
          <td class="text-center">${user.calls_made}</td>
          <td class="text-center">${user.stock_transactions}</td>
          <td class="text-center"><strong>${user.total_activity}</strong></td>
        `;
        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error("Error loading user activity:", error);
    }
  }

  async function loadInactiveCustomers() {
    const days = document.getElementById("inactivePeriod").value;

    try {
      const response = await fetch(
        `/admin/api/reports/inactive-customers?days=${days}`
      );
      const customers = await response.json();

      const listDiv = document.getElementById("inactiveCustomersList");
      listDiv.innerHTML = "";

      if (customers.length === 0) {
        listDiv.innerHTML =
          '<div class="alert alert-success"><i class="bi bi-check-circle-fill"></i> All customers contacted recently!</div>';
        return;
      }

      const table = document.createElement("table");
      table.className = "table table-hover";
      table.innerHTML = `
        <thead>
          <tr>
            <th>Customer</th>
            <th>Account</th>
            <th>Last Contact</th>
            <th>Days Ago</th>
            <th>Phone</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector("tbody");
      customers.forEach((customer) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><strong>${customer.name}</strong></td>
          <td><small>${customer.account_number}</small></td>
          <td>${
            customer.last_contact
              ? new Date(customer.last_contact).toLocaleDateString()
              : "Never"
          }</td>
          <td><span class="badge bg-danger">${
            customer.days_since_contact
          } days</span></td>
          <td><a href="tel:${
            customer.phone
          }" class="btn btn-sm btn-outline-primary"><i class="bi bi-telephone"></i> ${
          customer.phone
        }</a></td>
        `;
        tbody.appendChild(row);
      });

      listDiv.appendChild(table);
    } catch (error) {
      console.error("Error loading inactive customers:", error);
    }
  }

  async function loadCallsheetAnalytics(startDate, endDate) {
    try {
      const response = await fetch(
        `/admin/api/reports/callsheet-analytics?start_date=${startDate}&end_date=${endDate}`
      );
      const data = await response.json();

      document.getElementById("orderSuccessRate").textContent =
        data.order_success_rate + "%";
      document.getElementById("noAnswerRate").textContent =
        data.no_answer_rate + "%";
      document.getElementById("declineRate").textContent =
        data.decline_rate + "%";
      document.getElementById("callbackRate").textContent =
        data.callback_rate + "%";

      if (data.daily_success_rate) {
        updateDailyCallSuccessChart(data.daily_success_rate);
      }

      if (data.day_performance) {
        updateDayPerformanceChart(data.day_performance);
      }

      if (data.staff_performance) {
        updateStaffCallPerformanceChart(data.staff_performance);
      }

      updateMostResponsiveCustomers(data.most_responsive || []);
      updateHardToReachCustomers(data.hard_to_reach || []);
      updateFrequentDecliners(data.frequent_decliners || []);
      updatePendingCallbacks(data.pending_callbacks || []);
    } catch (error) {
      console.error("Error loading callsheet analytics:", error);
    }
  }

  function updateMostResponsiveCustomers(customers) {
    const div = document.getElementById("mostResponsiveCustomers");
    div.innerHTML = "";

    if (customers.length === 0) {
      div.innerHTML = '<p class="text-muted text-center">No data available</p>';
      return;
    }

    customers.slice(0, 10).forEach((customer, index) => {
      const item = document.createElement("div");
      item.className =
        "list-group-item d-flex justify-content-between align-items-center";
      item.innerHTML = `
        <div>
          <strong>${index + 1}. ${customer.name}</strong><br>
          <small class="text-muted">${customer.account_number}</small><br>
          <small class="text-success">${customer.orders}/${
        customer.total_calls
      } ordered</small>
        </div>
        <span class="badge bg-success rounded-pill">${
          customer.order_rate
        }%</span>
      `;
      div.appendChild(item);
    });
  }

  function updateHardToReachCustomers(customers) {
    const div = document.getElementById("hardToReachCustomers");
    div.innerHTML = "";

    if (customers.length === 0) {
      div.innerHTML = '<p class="text-muted text-center">No data available</p>';
      return;
    }

    customers.slice(0, 10).forEach((customer, index) => {
      const item = document.createElement("div");
      item.className =
        "list-group-item d-flex justify-content-between align-items-center";
      item.innerHTML = `
        <div>
          <strong>${index + 1}. ${customer.name}</strong><br>
          <small class="text-muted">${customer.account_number}</small><br>
          <small class="text-warning">${customer.no_answer}/${
        customer.total_calls
      } no answer</small>
        </div>
        <span class="badge bg-warning rounded-pill">${
          customer.no_answer_rate
        }%</span>
      `;
      div.appendChild(item);
    });
  }

  function updateFrequentDecliners(customers) {
    const div = document.getElementById("frequentDecliners");
    div.innerHTML = "";

    if (customers.length === 0) {
      div.innerHTML = '<p class="text-muted text-center">No data available</p>';
      return;
    }

    customers.slice(0, 10).forEach((customer, index) => {
      const item = document.createElement("div");
      item.className =
        "list-group-item d-flex justify-content-between align-items-center";
      item.innerHTML = `
        <div>
          <strong>${index + 1}. ${customer.name}</strong><br>
          <small class="text-muted">${customer.account_number}</small><br>
          <small class="text-danger">${customer.declined}/${
        customer.total_calls
      } declined</small>
        </div>
        <span class="badge bg-danger rounded-pill">${
          customer.decline_rate
        }%</span>
      `;
      div.appendChild(item);
    });
  }

  function updatePendingCallbacks(customers) {
    const div = document.getElementById("pendingCallbacks");
    div.innerHTML = "";

    if (customers.length === 0) {
      div.innerHTML =
        '<div class="alert alert-success"><i class="bi bi-check-circle-fill"></i> No pending callbacks</div>';
      return;
    }

    customers.forEach((customer) => {
      const item = document.createElement("div");
      item.className = "list-group-item";
      item.innerHTML = `
        <div class="d-flex justify-content-between">
          <div>
            <strong>${customer.name}</strong><br>
            <small class="text-muted">${customer.account_number}</small>
          </div>
          <div>
            <a href="tel:${
              customer.phone
            }" class="btn btn-sm btn-primary"><i class="bi bi-telephone"></i></a>
          </div>
        </div>
        ${
          customer.callback_time
            ? `<small class="text-info">Callback: ${customer.callback_time}</small>`
            : ""
        }
        ${
          customer.notes
            ? `<p class="mb-0 mt-1"><small>${customer.notes}</small></p>`
            : ""
        }
      `;
      div.appendChild(item);
    });
  }

  function updateDailyActivityChart(data) {
    const ctx = document.getElementById("dailyActivityChart").getContext("2d");

    if (dailyActivityChart) {
      dailyActivityChart.destroy();
    }

    dailyActivityChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: data.map((d) => d.date),
        datasets: [
          {
            label: "Forms",
            data: data.map((d) => d.forms),
            borderColor: "#007bff",
            backgroundColor: "rgba(0, 123, 255, 0.1)",
            fill: true,
          },
          {
            label: "Callsheets",
            data: data.map((d) => d.callsheets),
            borderColor: "#28a745",
            backgroundColor: "rgba(40, 167, 69, 0.1)",
            fill: true,
          },
          {
            label: "Stock",
            data: data.map((d) => d.stock),
            borderColor: "#ffc107",
            backgroundColor: "rgba(255, 193, 7, 0.1)",
            fill: true,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 },
          },
        },
      },
    });
  }

  function updateFormsTypeChart(data) {
    const ctx = document.getElementById("formsTypeChart").getContext("2d");

    if (formsTypeChart) {
      formsTypeChart.destroy();
    }

    const typeLabels = {
      returns: "Returns",
      branded_stock: "Customer's Own Stock",
      invoice_correction: "Invoiced Goods",
      special_order: "Special Orders",
    };

    formsTypeChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: data.map((d) => typeLabels[d.type] || d.type),
        datasets: [
          {
            data: data.map((d) => d.count),
            backgroundColor: ["#007bff", "#28a745", "#ffc107", "#dc3545"],
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: "bottom" },
        },
      },
    });
  }

  function updateCallsheetStatusChart(data) {
    const ctx = document
      .getElementById("callsheetStatusChart")
      .getContext("2d");

    if (callsheetStatusChart) {
      callsheetStatusChart.destroy();
    }

    const statusLabels = {
      not_called: "Not Called",
      no_answer: "No Answer",
      declined: "Declined",
      ordered: "Ordered",
      callback: "Callback",
    };

    const statusColors = {
      not_called: "#6c757d",
      no_answer: "#ffc107",
      declined: "#dc3545",
      ordered: "#28a745",
      callback: "#17a2b8",
    };

    callsheetStatusChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.map((d) => statusLabels[d.status] || d.status),
        datasets: [
          {
            label: "Call Status",
            data: data.map((d) => d.count),
            backgroundColor: data.map(
              (d) => statusColors[d.status] || "#007bff"
            ),
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 },
          },
        },
      },
    });
  }

  function updateDailyCallSuccessChart(data) {
    const ctx = document
      .getElementById("dailyCallSuccessChart")
      .getContext("2d");

    if (dailyCallSuccessChart) {
      dailyCallSuccessChart.destroy();
    }

    dailyCallSuccessChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: data.map((d) => d.date),
        datasets: [
          {
            label: "Success Rate %",
            data: data.map((d) => d.success_rate),
            borderColor: "#28a745",
            backgroundColor: "rgba(40, 167, 69, 0.1)",
            fill: true,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function (value) {
                return value + "%";
              },
            },
          },
        },
      },
    });
  }

  function updateDayPerformanceChart(data) {
    const ctx = document.getElementById("dayPerformanceChart").getContext("2d");

    if (dayPerformanceChart) {
      dayPerformanceChart.destroy();
    }

    const days = [
      "Monday",
      "Tuesday",
      "Wednesday",
      "Thursday",
      "Friday",
      "Saturday",
      "Sunday",
    ];
    const dayData = days.map((day) => data[day] || 0);

    dayPerformanceChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: days,
        datasets: [
          {
            label: "Success Rate %",
            data: dayData,
            backgroundColor: "rgba(75, 192, 192, 0.6)",
            borderColor: "rgba(75, 192, 192, 1)",
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function (value) {
                return value + "%";
              },
            },
          },
        },
      },
    });
  }

  function updateStaffCallPerformanceChart(data) {
    const ctx = document
      .getElementById("staffCallPerformanceChart")
      .getContext("2d");

    if (staffCallPerformanceChart) {
      staffCallPerformanceChart.destroy();
    }

    staffCallPerformanceChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.map((d) => d.username),
        datasets: [
          {
            label: "Order Success Rate %",
            data: data.map((d) => d.success_rate),
            backgroundColor: "rgba(153, 102, 255, 0.6)",
            borderColor: "rgba(153, 102, 255, 1)",
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function (value) {
                return value + "%";
              },
            },
          },
        },
      },
    });
  }

  function exportReport() {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    alert(
      `Report export functionality would export data from ${startDate} to ${endDate}.\n\nThis can be implemented to generate PDF or Excel reports.`
    );

    window.print();
  }

  document.addEventListener("DOMContentLoaded", function () {
    updateDateRange();
    loadAllReports();
  });
</script>

<style>
  .card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin-bottom: 1rem;
  }

  .list-group-item {
    border-left: 3px solid transparent;
    transition: all 0.2s;
  }

  .list-group-item:hover {
    border-left-color: #007bff;
    background-color: rgba(0, 123, 255, 0.05);
  }

  .table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    color: #6c757d;
  }

  @media print {
    .btn,
    .form-control,
    .form-select {
      display: none !important;
    }
  }
</style>

{% endblock %}
