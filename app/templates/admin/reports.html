{% extends "base.html" %} {% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-graph-up"></i> Admin Reports</h2>
  </div>

  <!-- Date Range Filter -->
  <div class="card mb-4">
    <div class="card-header">
      <h5><i class="bi bi-calendar-range"></i> Report Filters</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="dateFrom" class="form-label">From Date</label>
          <input
            type="date"
            class="form-control"
            id="dateFrom"
            min="{{ min_date }}"
            max="{{ max_date }}"
            value="{{ (max_date | string)[:7] + '-01' }}"
          />
        </div>
        <div class="col-md-3">
          <label for="dateTo" class="form-label">To Date</label>
          <input
            type="date"
            class="form-control"
            id="dateTo"
            min="{{ min_date }}"
            max="{{ max_date }}"
            value="{{ max_date }}"
          />
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button class="btn btn-primary w-100" onclick="loadCallsheetReport()">
            <i class="bi bi-search"></i> Generate Report
          </button>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button
            class="btn btn-outline-secondary w-100"
            onclick="exportToCSV()"
          >
            <i class="bi bi-download"></i> Export CSV
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div id="kpiSection" class="row mb-4" style="display: none">
    <div class="col-md-2">
      <div class="card text-center">
        <div class="card-body">
          <h3 id="kpiTotal" class="text-primary">0</h3>
          <small class="text-muted">Total Entries</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center">
        <div class="card-body">
          <h3 id="kpiOrdered" class="text-success">0</h3>
          <small class="text-muted">Ordered</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center">
        <div class="card-body">
          <h3 id="kpiNoAnswer" class="text-warning">0</h3>
          <small class="text-muted">No Answer</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center">
        <div class="card-body">
          <h3 id="kpiDeclined" class="text-danger">0</h3>
          <small class="text-muted">Declined</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center">
        <div class="card-body">
          <h3 id="kpiCallback" class="text-info">0</h3>
          <small class="text-muted">Callback</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card text-center">
        <div class="card-body">
          <h3 id="kpiSuccess" class="text-primary">0%</h3>
          <small class="text-muted">Success Rate</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Callsheet Report Tabs -->
  <div id="reportSection" style="display: none">
    <div class="card">
      <div class="card-header">
        <h5><i class="bi bi-telephone"></i> Callsheet Activity by Day</h5>
        <small class="text-muted"
          >Data grouped by the callsheet's assigned day of week</small
        >
      </div>
      <div class="card-body">
        <!-- Day Tabs -->
        <ul class="nav nav-tabs" id="dayTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="monday-tab"
              data-bs-toggle="tab"
              data-bs-target="#monday"
              type="button"
            >
              Monday
              <span class="badge bg-secondary ms-1" id="mondayCount">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="tuesday-tab"
              data-bs-toggle="tab"
              data-bs-target="#tuesday"
              type="button"
            >
              Tuesday
              <span class="badge bg-secondary ms-1" id="tuesdayCount">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="wednesday-tab"
              data-bs-toggle="tab"
              data-bs-target="#wednesday"
              type="button"
            >
              Wednesday
              <span class="badge bg-secondary ms-1" id="wednesdayCount">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="thursday-tab"
              data-bs-toggle="tab"
              data-bs-target="#thursday"
              type="button"
            >
              Thursday
              <span class="badge bg-secondary ms-1" id="thursdayCount">0</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="friday-tab"
              data-bs-toggle="tab"
              data-bs-target="#friday"
              type="button"
            >
              Friday
              <span class="badge bg-secondary ms-1" id="fridayCount">0</span>
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3" id="dayTabsContent">
          <div class="tab-pane fade show active" id="monday" role="tabpanel">
            <div id="mondayContent"></div>
          </div>
          <div class="tab-pane fade" id="tuesday" role="tabpanel">
            <div id="tuesdayContent"></div>
          </div>
          <div class="tab-pane fade" id="wednesday" role="tabpanel">
            <div id="wednesdayContent"></div>
          </div>
          <div class="tab-pane fade" id="thursday" role="tabpanel">
            <div id="thursdayContent"></div>
          </div>
          <div class="tab-pane fade" id="friday" role="tabpanel">
            <div id="fridayContent"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loadingIndicator" class="text-center py-5" style="display: none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Generating report...</p>
  </div>
</div>

<script>
  let currentReportData = null;

  async function loadCallsheetReport() {
    const dateFrom = document.getElementById("dateFrom").value;
    const dateTo = document.getElementById("dateTo").value;

    if (!dateFrom || !dateTo) {
      alert("Please select both start and end dates");
      return;
    }

    if (new Date(dateFrom) > new Date(dateTo)) {
      alert("Start date must be before end date");
      return;
    }

    // Show loading
    document.getElementById("loadingIndicator").style.display = "block";
    document.getElementById("kpiSection").style.display = "none";
    document.getElementById("reportSection").style.display = "none";

    try {
      const response = await fetch("/api/admin/callsheet-report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          date_from: dateFrom,
          date_to: dateTo,
        }),
      });

      const data = await response.json();

      if (data.success) {
        currentReportData = data;
        displayReport(data);
      } else {
        alert("Error: " + data.message);
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Failed to generate report");
    } finally {
      document.getElementById("loadingIndicator").style.display = "none";
    }
  }

  function displayReport(data) {
    // Update KPIs
    document.getElementById("kpiTotal").textContent = data.kpis.total_entries;
    document.getElementById("kpiOrdered").textContent = data.kpis.ordered;
    document.getElementById("kpiNoAnswer").textContent = data.kpis.no_answer;
    document.getElementById("kpiDeclined").textContent = data.kpis.declined;
    document.getElementById("kpiCallback").textContent = data.kpis.callback;
    document.getElementById("kpiSuccess").textContent =
      data.kpis.success_rate + "%";

    // Show sections
    document.getElementById("kpiSection").style.display = "flex";
    document.getElementById("reportSection").style.display = "block";

    // Update day tabs
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    days.forEach((day) => {
      const dayData = data.stats_by_day[day];
      const dayLower = day.toLowerCase();

      // Update count badge
      document.getElementById(dayLower + "Count").textContent =
        dayData.total_entries;

      // Generate day content
      const content = generateDayContent(day, dayData);
      document.getElementById(dayLower + "Content").innerHTML = content;
    });
  }

  function generateDayContent(day, dayData) {
    if (dayData.total_entries === 0) {
      return (
        '<div class="alert alert-info">No callsheet activity for ' +
        day +
        " in the selected date range.</div>"
      );
    }

    let html = `
        <div class="row mb-3">
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body p-2">
                        <h5>${dayData.ordered}</h5>
                        <small>Ordered</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body p-2">
                        <h5>${dayData.no_answer}</h5>
                        <small>No Answer</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body p-2">
                        <h5>${dayData.declined}</h5>
                        <small>Declined</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body p-2">
                        <h5>${dayData.callback}</h5>
                        <small>Callback</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body p-2">
                        <h5>${dayData.not_called}</h5>
                        <small>Not Called</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center bg-light">
                    <div class="card-body p-2">
                        <h5>${dayData.conversion_rate.toFixed(1)}%</h5>
                        <small>Conversion</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Callsheet</th>
                        <th>Status</th>
                        <th>Called By</th>
                        <th>Person Contacted</th>
                        <th>Updated</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
    `;

    dayData.entries.forEach((entry) => {
      const statusBadge = getStatusBadge(entry.call_status);
      html += `
            <tr>
                <td>${entry.customer_name}</td>
                <td><small>${entry.callsheet_name}</small></td>
                <td>${statusBadge}</td>
                <td><small>${entry.called_by}</small></td>
                <td><small>${entry.person_spoken_to}</small></td>
                <td><small>${entry.updated_at}</small></td>
                <td>
                    ${
                      entry.call_notes
                        ? '<button class="btn btn-sm btn-outline-secondary" onclick="showNotes(\'' +
                          entry.call_notes.replace(/'/g, "\\'") +
                          '\')"><i class="bi bi-chat-dots"></i></button>'
                        : "-"
                    }
                </td>
            </tr>
        `;
    });

    html += "</tbody></table></div>";
    return html;
  }

  function getStatusBadge(status) {
    const badges = {
      not_called: '<span class="badge bg-secondary">Not Called</span>',
      no_answer: '<span class="badge bg-warning">No Answer</span>',
      declined: '<span class="badge bg-danger">Declined</span>',
      ordered: '<span class="badge bg-success">Ordered</span>',
      callback: '<span class="badge bg-info">Callback</span>',
    };
    return badges[status] || status;
  }

  function showNotes(notes) {
    alert("Notes:\n\n" + notes);
  }

  function exportToCSV() {
    if (!currentReportData) {
      alert("Please generate a report first");
      return;
    }

    let csv =
      "Day,Customer,Callsheet,Status,Called By,Person Contacted,Updated,Notes\n";

    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    days.forEach((day) => {
      const dayData = currentReportData.stats_by_day[day];
      dayData.entries.forEach((entry) => {
        csv += `${day},"${entry.customer_name}","${entry.callsheet_name}",${
          entry.call_status
        },"${entry.called_by}","${entry.person_spoken_to}",${
          entry.updated_at
        },"${entry.call_notes.replace(/"/g, '""')}"\n`;
      });
    });

    // Download
    const blob = new Blob([csv], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `callsheet_report_${currentReportData.date_range.from}_to_${currentReportData.date_range.to}.csv`;
    a.click();
  }

  // Load initial report on page load
  window.addEventListener("load", () => {
    // Set default dates to current month
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

    document.getElementById("dateFrom").value = firstDay
      .toISOString()
      .split("T")[0];
    document.getElementById("dateTo").value = today.toISOString().split("T")[0];

    // Auto-generate report
    loadCallsheetReport();
  });
</script>
{% endblock %}
